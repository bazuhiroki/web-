<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資格取得管理ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        /* カスタムスクロールバー */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; } /* bg-gray-800 */
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; } /* bg-gray-600 */
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* bg-gray-500 */
        /* Plotlyのツールバーの色を調整 */
        .modebar-btn path { fill: #9ca3af !important; }
        .modebar-btn:hover path { fill: #f9fafb !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="root" class="h-screen"></div>

    <!-- ライブラリの読み込み -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
    <script src="https://cdn.plot.ly/latest/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebaseの読み込み -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // グローバルスコープにFirebaseの関数を公開
        window.firebase = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithRedirect,
            getRedirectResult,
            signOut,
            signInAnonymously,
            getFirestore,
            doc,
            setDoc,
            onSnapshot
        };
    </script>
    
    <!-- Reactコード -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const { initializeApp, getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut, signInAnonymously, getFirestore, doc, setDoc, onSnapshot } = window.firebase;
        const { uuidv4, XLSX, Plotly } = window;

        // --- 3Dプロットコンポーネント ---
        const ScatterPlot = ({ data }) => {
            const plotRef = useRef(null);
            const [plotStatus, setPlotStatus] = useState('loading');

            useEffect(() => {
                const timeout = setTimeout(() => {
                    if (typeof window.Plotly === 'undefined') {
                        setPlotStatus('error');
                    }
                }, 7000); // 7秒でタイムアウト

                const interval = setInterval(() => {
                    if (typeof window.Plotly !== 'undefined') {
                        setPlotStatus('ready');
                        clearInterval(interval);
                        clearTimeout(timeout);
                    }
                }, 100);

                return () => {
                    clearInterval(interval);
                    clearTimeout(timeout);
                };
            }, []);

            useEffect(() => {
                if (plotStatus !== 'ready') return;
                const plotDiv = plotRef.current;
                if (!plotDiv) return;
                Plotly.purge(plotDiv);
                if (!data || data.length === 0) return;
                try {
                    const df = data.filter(cert => cert.name && !isNaN(cert.difficulty) && !isNaN(cert.necessity) && !isNaN(cert.gai));
                    const axisRange = [0, 6];
                    const plotData = [{
                        x: df.map(c => c.difficulty), y: df.map(c => c.necessity), z: df.map(c => c.gai),
                        mode: 'markers+text', type: 'scatter3d',
                        marker: {
                            size: df.map(c => c.gai + 4), color: df.map(c => c.gai),
                            colorscale: 'Viridis', colorbar: { title: 'やりがい', tickfont: { color: '#f3f4f6' }, titlefont: { color: '#f3f4f6' } },
                            opacity: 0.8
                        },
                        text: df.map(c => c.name), textfont: { color: 'white', size: 10 },
                        textposition: 'top center', hoverinfo: 'text',
                        hoverlabel: { bgcolor: '#1f2937', font: { color: 'white' } }
                    }];
                    const layout = {
                        title: { text: '資格取得の優先順位', font: { color: '#f3f4f6' } },
                        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                        font: { color: '#f3f4f6' }, margin: { l: 0, r: 0, b: 0, t: 40 },
                        scene: {
                            xaxis: { title: '難易度', range: axisRange, gridcolor: '#374151', zerolinecolor: '#4b5563', titlefont: { color: '#9ca3af' }, tickfont: { color: '#9ca3af' } },
                            yaxis: { title: '必要性', range: axisRange, gridcolor: '#374151', zerolinecolor: '#4b5563', titlefont: { color: '#9ca3af' }, tickfont: { color: '#9ca3af' } },
                            zaxis: { title: 'やりがい', range: axisRange, gridcolor: '#374151', zerolinecolor: '#4b5563', titlefont: { color: '#9ca3af' }, tickfont: { color: '#9ca3af' } },
                            aspectratio: { x: 1, y: 1, z: 1 }, camera: { eye: { x: 1.5, y: 1.5, z: 1.5 } }
                        },
                        showlegend: false
                    };
                    Plotly.react(plotDiv, plotData, layout, { responsive: true, displaylogo: false });
                } catch (e) { console.error("Plotlyチャートの描画中にエラーが発生しました:", e); }
            }, [data, plotStatus]);

            return (
                <div ref={plotRef} className="w-full h-full">
                    {plotStatus === 'loading' && <div className="flex items-center justify-center h-full text-gray-400">グラフ描画ライブラリを読み込み中...</div>}
                    {plotStatus === 'error' && <div className="flex items-center justify-center h-full text-red-400 bg-red-900/20 rounded-lg p-4 text-center">グラフ描画ライブラリの読み込みに失敗しました。<br/>時間をおいてページを再読み込みしてください。</div>}
                    {plotStatus === 'ready' && (!data || data.length === 0) && <div className="flex items-center justify-center h-full text-gray-500 bg-gray-800/50 rounded-lg p-4 text-center">表示するデータがありません。<br/>左のフォームから資格情報を追加またはアップロードしてください。</div>}
                </div>
            );
        };

        // --- メインアプリケーションコンポーネント ---
        const App = () => {
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [data, setData] = useState({ certifications: [], progress: {} });
            const [currentTab, setCurrentTab] = useState('tab-1');
            const [editingCert, setEditingCert] = useState(null);
            const [currentCertId, setCurrentCertId] = useState(null);
            const [certForm, setCertForm] = useState({ name: '', difficulty: 3, necessity: 3, gai: 3 });
            const [filters, setFilters] = useState({ difficulty: { min: 1, max: 5 }, necessity: { min: 1, max: 5 }, gai: { min: 1, max: 5 } });
            const [newMajorItemName, setNewMajorItemName] = useState('');
            const [newMinorItemName, setNewMinorItemName] = useState('');
            const [parentMajorItemId, setParentMajorItemId] = useState('');
            const [loadingReport, setLoadingReport] = useState(false);
            const [report, setReport] = useState('');
            const [reporter, setReporter] = useState('熱血コーチ');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalMessage, setModalMessage] = useState('');
            const [modalAction, setModalAction] = useState(null);
            
            useEffect(() => {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                if (Object.keys(firebaseConfig).length === 0) { setIsLoading(false); return; }
                const app = initializeApp(firebaseConfig);
                const authInstance = getAuth(app);
                const firestoreInstance = getFirestore(app);
                setAuth(authInstance);
                setDb(firestoreInstance);

                // リダイレクトからの復帰時に結果を処理
                getRedirectResult(authInstance)
                    .catch((error) => {
                        console.error("Redirect Result Error:", error);
                        openModal(`ログインに失敗しました: ${error.message}`);
                    });

                const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                    setUser(user);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!db || !user) { setData({ certifications: [], progress: {} }); return; }
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
                const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const storedData = docSnap.data();
                        setData({
                            certifications: storedData.certifications ? JSON.parse(storedData.certifications) : [],
                            progress: storedData.progress ? JSON.parse(storedData.progress) : {}
                        });
                    } else { setData({ certifications: [], progress: {} }); }
                }, (error) => console.error("Firestore snapshot error:", error));
                return () => unsubscribe();
            }, [db, user]);
            
            const handleGoogleSignIn = async () => {
                if (!auth) return;
                const provider = new GoogleAuthProvider();
                await signInWithRedirect(auth, provider);
            };
            // ▼▼▼ 変更点: 匿名ログイン用のハンドラを追加 ▼▼▼
            const handleAnonymousSignIn = async () => {
                if (!auth) return;
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Anonymous Sign-In error:", error);
                    openModal(`匿名ログインに失敗しました: ${error.message}`);
                }
            };
            const handleSignOut = async () => { if (auth) await signOut(auth); };

            const saveDataToFirestore = useCallback(async (newData) => {
                if (!db || !user) return;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
                await setDoc(userDocRef, {
                    certifications: JSON.stringify(newData.certifications),
                    progress: JSON.stringify(newData.progress),
                }, { merge: true }).catch(err => openModal(`データ保存エラー: ${err.message}`));
            }, [db, user]);

            useEffect(() => {
                if (editingCert) { setCertForm(editingCert); } 
                else { setCertForm({ name: '', difficulty: 3, necessity: 3, gai: 3 }); }
            }, [editingCert]);

            const openModal = (message, onConfirm = null) => {
                setModalMessage(message);
                setModalAction(() => onConfirm);
                setIsModalOpen(true);
            };
            const closeModal = () => setIsModalOpen(false);
            const handleFormChange = (e) => {
                const { name, value } = e.target;
                setCertForm(prev => ({ ...prev, [name]: value }));
            };
            const handleAddUpdateCert = async () => {
                if (!certForm.name.trim()) { openModal('資格名を入力してください。'); return; }
                const newCert = { ...certForm, id: editingCert ? editingCert.id : uuidv4(), difficulty: Number(certForm.difficulty), necessity: Number(certForm.necessity), gai: Number(certForm.gai) };
                const updatedCerts = editingCert ? data.certifications.map(c => c.id === newCert.id ? newCert : c) : [...data.certifications, newCert];
                await saveDataToFirestore({ ...data, certifications: updatedCerts });
                setEditingCert(null);
            };
            const handleDeleteCert = (id) => {
                openModal('この資格情報を削除しますか？', async () => {
                    const updatedCerts = data.certifications.filter(c => c.id !== id);
                    const updatedProgress = { ...data.progress };
                    delete updatedProgress[id];
                    await saveDataToFirestore({ certifications: updatedCerts, progress: updatedProgress });
                    if (currentCertId === id) setCurrentCertId(null);
                    closeModal();
                });
            };
            const handleFilterChange = (filterName, type, value) => {
                setFilters(prev => {
                    const newFilter = { ...prev[filterName], [type]: Number(value) };
                    if (type === 'min' && newFilter.min > newFilter.max) newFilter.max = newFilter.min;
                    if (type === 'max' && newFilter.max < newFilter.min) newFilter.min = newFilter.max;
                    return { ...prev, [filterName]: newFilter };
                });
            };
            const handleCertFileUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        let newCerts = [];
                        if (file.name.endsWith('.json')) { newCerts = JSON.parse(event.target.result).map(c => ({...c, id: c.id || uuidv4()})); } 
                        else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                            const wb = XLSX.read(event.target.result, { type: 'binary' });
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(ws, { header: ['name', 'difficulty', 'necessity', 'gai'], range: 1 });
                            newCerts = jsonData.filter(c => c.name && !isNaN(c.difficulty) && !isNaN(c.necessity) && !isNaN(c.gai)).map(c => ({...c, id: uuidv4()}));
                        }
                        if (newCerts.length > 0) {
                            await saveDataToFirestore({ ...data, certifications: newCerts });
                            openModal(`${newCerts.length}件の資格情報をアップロードしました。`);
                        } else { openModal('有効なデータが見つかりませんでした。'); }
                    } catch (error) { openModal(`ファイルの読み込みに失敗しました: ${error.message}`); }
                };
                reader.readAsBinaryString(file); e.target.value = null;
            };
            const handleProgressFileUpload = (e) => {
                const file = e.target.files[0]; if (!file || !currentCertId) { openModal("先に学習中の資格を選択してください。"); return; }
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const workbook = XLSX.read(event.target.result, { type: 'binary' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        const items = {}; let currentMajorItemKey = null;
                        jsonData.forEach(row => {
                            const cellValue = row[0];
                            if (typeof cellValue === 'string' && cellValue.trim() !== '') {
                                const trimmedValue = cellValue.trim();
                                if (trimmedValue.startsWith('●')) {
                                    currentMajorItemKey = uuidv4();
                                    items[currentMajorItemKey] = { name: trimmedValue.substring(1).trim(), checked: false, type: 'major', subItems: {} };
                                } else if ((trimmedValue.startsWith('・') || trimmedValue.startsWith('-')) && currentMajorItemKey) {
                                    const subItemKey = uuidv4();
                                    items[currentMajorItemKey].subItems[subItemKey] = { name: trimmedValue.substring(1).trim(), checked: false, type: 'minor' };
                                }
                            }
                        });
                        const updatedProgress = { ...data.progress, [currentCertId]: { ...data.progress[currentCertId], items } };
                        await saveDataToFirestore({ ...data, progress: updatedProgress });
                        openModal('学習項目のアップロードが完了しました！');
                    } catch (error) { openModal('ファイルの読み込み中にエラーが発生しました。'); }
                };
                reader.readAsBinaryString(file);
            };
            const handleProgressCheckbox = async (minorId, majorId) => {
                const updatedProgress = { ...data.progress };
                const certProgress = updatedProgress[currentCertId];
                if (certProgress?.items?.[majorId]?.subItems?.[minorId]) {
                    certProgress.items[majorId].subItems[minorId].checked = !certProgress.items[majorId].subItems[minorId].checked;
                    certProgress.items[majorId].checked = Object.values(certProgress.items[majorId].subItems).every(item => item.checked);
                    await saveDataToFirestore({ ...data, progress: updatedProgress });
                }
            };
            const handleAddMajorItem = async () => {
                if (!currentCertId || !newMajorItemName.trim()) return;
                const updatedProgress = { ...data.progress };
                const currentCertProgress = updatedProgress[currentCertId] || { items: {} };
                const newMajorKey = uuidv4();
                currentCertProgress.items[newMajorKey] = { name: newMajorItemName.trim(), checked: false, type: 'major', subItems: {} };
                updatedProgress[currentCertId] = currentCertProgress;
                await saveDataToFirestore({ ...data, progress: updatedProgress });
                setNewMajorItemName('');
            };
            const handleAddMinorItem = async () => {
                if (!currentCertId || !newMinorItemName.trim() || !parentMajorItemId) return;
                const updatedProgress = { ...data.progress };
                const currentCertProgress = updatedProgress[currentCertId];
                if (currentCertProgress?.items?.[parentMajorItemId]) {
                    const newMinorKey = uuidv4();
                    currentCertProgress.items[parentMajorItemId].subItems[newMinorKey] = { name: newMinorItemName.trim(), checked: false, type: 'minor' };
                    await saveDataToFirestore({ ...data, progress: { ...data.progress, [currentCertId]: currentCertProgress } });
                    setNewMinorItemName('');
                }
            };
            const filteredCerts = useMemo(() => {
                return data.certifications.filter(cert => 
                    cert.difficulty >= filters.difficulty.min && cert.difficulty <= filters.difficulty.max &&
                    cert.necessity >= filters.necessity.min && cert.necessity <= filters.necessity.max &&
                    cert.gai >= filters.gai.min && cert.gai <= filters.gai.max
                );
            }, [data.certifications, filters]);
            const generateReport = async () => {
                setLoadingReport(true); setReport('');
                try {
                    const certInfo = data.certifications.find(c => c.id === currentCertId);
                    const progressData = data.progress[currentCertId];
                    if (!certInfo || !progressData || !progressData.items) throw new Error('レポート生成に必要な進捗データがありません。');
                    let total = 0, checked = 0;
                    Object.values(progressData.items).forEach(major => {
                        total += Object.keys(major.subItems || {}).length;
                        checked += Object.values(major.subItems || {}).filter(sub => sub.checked).length;
                    });
                    const progressPercent = total > 0 ? (checked / total) * 100 : 0;
                    const prompt = `あなたは「${reporter}」です。以下の学習進捗について、そのキャラクターになりきって学習者を力強く励ます評価と次に取り組むべきアクションを提案してください。レポートは情熱的かつ分かりやすく、markdown形式で記述してください。\n### 学習進捗レポート\n- **資格名**: ${certInfo.name}\n- **総学習項目数**: ${total}\n- **完了項目数**: ${checked}\n- **進捗率**: ${progressPercent.toFixed(1)}%`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    setReport(result?.candidates?.[0]?.content?.parts?.[0]?.text || 'レポート生成に失敗しました。');
                } catch (error) { setReport(`レポート生成中にエラーが発生しました: ${error.message}`); }
                setLoadingReport(false);
            };

            // --- レンダリングロジック ---
            if (isLoading) {
                return <div className="flex items-center justify-center h-full text-white">読み込み中...</div>;
            }
            if (!user) {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-gray-900 text-white p-4">
                        {isModalOpen && <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                            <div className="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                                <p className="text-white mb-6">{modalMessage}</p>
                                <div className="flex justify-end space-x-4">
                                    {modalAction && <button onClick={() => { modalAction(); closeModal(); }} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">はい</button>}
                                    <button onClick={closeModal} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">{modalAction ? 'キャンセル' : '閉じる'}</button>
                                </div>
                            </div>
                        </div>}
                        <h1 className="text-4xl font-extrabold mb-4 text-center">資格取得管理ダッシュボード</h1>
                        <p className="text-lg text-gray-400 mb-8 text-center">Googleアカウントでログイン、または匿名で続行してください。</p>
                        {/* ▼▼▼ 変更点: ログインボタンを2つに分離 ▼▼▼ */}
                        <div className="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                            <button onClick={handleGoogleSignIn} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center space-x-2 transition-transform transform hover:scale-105">
                                <svg className="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,36.626,44,30.638,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                                <span>Googleでログイン</span>
                            </button>
                            <button onClick={handleAnonymousSignIn} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center space-x-2 transition-transform transform hover:scale-105">
                                <span>匿名で続ける</span>
                            </button>
                        </div>
                        <p className="text-xs text-gray-500 mt-4 text-center max-w-md">Googleログインでデータを永続的に保存できます。匿名ログインの場合、データはブラウザを閉じるまでの一時的な保存となります。</p>
                    </div>
                );
            }

            // --- ログイン後のメイン画面 ---
            return (
                <div className="min-h-screen p-4">
                    {isModalOpen && <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div className="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                            <p className="text-white mb-6">{modalMessage}</p>
                            <div className="flex justify-end space-x-4">
                                {modalAction && <button onClick={() => { modalAction(); closeModal(); }} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">はい</button>}
                                <button onClick={closeModal} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">{modalAction ? 'キャンセル' : '閉じる'}</button>
                            </div>
                        </div>
                    </div>}
                    <header className="text-center mb-8">
                        <div className="flex justify-center items-center relative">
                            <h1 className="text-4xl font-extrabold text-white" style={{fontFamily: "'Inter', sans-serif"}}>資格取得管理ダッシュボード</h1>
                            <div className="absolute right-0 flex items-center space-x-4">
                                {user.photoURL && <img src={user.photoURL} alt="User" className="w-10 h-10 rounded-full" />}
                                <button onClick={handleSignOut} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">ログアウト</button>
                            </div>
                        </div>
                        <div className="mt-2 text-sm text-gray-400">ようこそ、{user.isAnonymous ? 'ゲスト' : user.displayName}さん</div>
                    </header>
                    <nav className="mb-8 border-b border-gray-700">
                        <div className="flex justify-center space-x-4">
                            {[{id: 'tab-1', label: '優先順位付け'}, {id: 'tab-2', label: '進捗管理'}, {id: 'tab-3', label: 'レポート'}].map(tab => (
                                <button key={tab.id} onClick={() => setCurrentTab(tab.id)} className={`py-2 px-4 font-bold rounded-t-lg ${currentTab === tab.id ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-700/50'}`}>
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                    </nav>
                    <main>
                        {currentTab === 'tab-1' && <div className="flex flex-col lg:flex-row p-4 gap-4">
                            <div className="w-full lg:w-1/3 space-y-4">
                                <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                    <h3 className="text-xl font-bold mb-2">1. 資格情報アップロード</h3>
                                    <p className="text-sm text-gray-400 mb-2">Excel(.xlsx)またはJSON(.json)形式。<br/>Excel: A列=資格名, B=難易度, C=必要性, D=やりがい (2行目から)</p>
                                    <input type="file" accept=".json,.xlsx,.xls" onChange={handleCertFileUpload} className="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer"/>
                                </div>
                                <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                    <h3 className="text-xl font-bold mb-4">2. フィルター</h3>
                                    {['difficulty', 'necessity', 'gai'].map(key => {
                                        const labels = {difficulty: '難易度', necessity: '必要性', gai: 'やりがい'};
                                        return (
                                        <div key={key} className="mb-2">
                                            <label className="block text-sm font-medium mb-1">{labels[key]} ({filters[key].min} - {filters[key].max})</label>
                                            <div className="flex items-center space-x-2">
                                                <span>1</span>
                                                <input type="range" min="1" max="5" value={filters[key].min} onChange={e => handleFilterChange(key, 'min', e.target.value)} className="w-full" />
                                                <input type="range" min="1" max="5" value={filters[key].max} onChange={e => handleFilterChange(key, 'max', e.target.value)} className="w-full" />
                                                <span>5</span>
                                            </div>
                                        </div>
                                    )})}
                                </div>
                                <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                    <h3 className="text-xl font-bold mb-4">{editingCert ? '資格情報の編集' : '3. 資格情報の手動追加'}</h3>
                                    <div className="space-y-4">
                                        <input type="text" name="name" value={certForm.name} onChange={handleFormChange} placeholder="資格名" className="w-full p-2 bg-gray-700 rounded-md"/>
                                        {['difficulty', 'necessity', 'gai'].map(key => (
                                        <div key={key}>
                                            <label className="block text-sm font-medium mb-1">{({difficulty: '難易度', necessity: '必要性', gai: 'やりがい'})[key]} (1-5)</label>
                                            <input type="number" name={key} value={certForm[key]} onChange={handleFormChange} min="1" max="5" className="w-full p-2 bg-gray-700 rounded-md"/>
                                        </div>
                                        ))}
                                        <button onClick={handleAddUpdateCert} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">{editingCert ? '更新' : '追加'}</button>
                                        {editingCert && <button onClick={() => setEditingCert(null)} className="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2">キャンセル</button>}
                                    </div>
                                </div>
                            </div>
                            <div className="w-full lg:w-2/3 space-y-4">
                                <div className="bg-gray-800 p-4 rounded-lg shadow-lg"><div className="w-full h-[60vh] min-h-[400px]"><ScatterPlot data={filteredCerts} /></div></div>
                                <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                    <h3 className="text-xl font-bold mb-4">資格一覧</h3>
                                    <div className="overflow-auto max-h-[40vh]">
                                        <table className="min-w-full divide-y divide-gray-700">
                                            <thead className="bg-gray-700 sticky top-0"><tr>{['資格名', '難易度', '必要性', 'やりがい', 'アクション'].map(h => <th key={h} className="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase">{h}</th>)}</tr></thead>
                                            <tbody className="bg-gray-800 divide-y divide-gray-700">
                                                {filteredCerts.length > 0 ? filteredCerts.map(cert => (
                                                    <tr key={cert.id} className="hover:bg-gray-700/50">
                                                        <td className="px-4 py-2 text-sm font-medium text-white">{cert.name}</td>
                                                        <td className="px-4 py-2 text-sm text-gray-300">{cert.difficulty}</td>
                                                        <td className="px-4 py-2 text-sm text-gray-300">{cert.necessity}</td>
                                                        <td className="px-4 py-2 text-sm text-gray-300">{cert.gai}</td>
                                                        <td className="px-4 py-2 text-sm font-medium space-x-2">
                                                            <button onClick={() => setEditingCert(cert)} className="text-indigo-400 hover:text-indigo-600">編集</button>
                                                            <button onClick={() => handleDeleteCert(cert.id)} className="text-red-400 hover:text-red-600">削除</button>
                                                        </td>
                                                    </tr>
                                                )) : (<tr><td colSpan="5" className="text-center py-4 text-gray-500">該当する資格がありません。</td></tr>)}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>}
                        {currentTab === 'tab-2' && <div className="flex flex-col lg:flex-row p-4 gap-4">
                            <div className="w-full lg:w-1/3 space-y-4">
                                <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                    <h3 className="text-xl font-bold mb-4">学習中の資格設定</h3>
                                    <select value={currentCertId || ''} onChange={(e) => setCurrentCertId(e.target.value)} className="w-full p-2 bg-gray-700 rounded-md mb-4">
                                        <option value="">資格を選択...</option>
                                        {data.certifications.map((cert) => <option key={cert.id} value={cert.id}>{cert.name}</option>)}
                                    </select>
                                    <label className="block text-sm font-medium mb-1">目標取得日</label>
                                    <input type="date" value={data.progress[currentCertId]?.targetDate || ''} onChange={async (e) => {
                                        if (!currentCertId) return;
                                        const updatedProgress = { ...data.progress, [currentCertId]: { ...data.progress[currentCertId], targetDate: e.target.value } };
                                        await saveDataToFirestore({ ...data, progress: updatedProgress });
                                    }} className="w-full p-2 bg-gray-700 rounded-md"/>
                                </div>
                                <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                    <h3 className="text-xl font-bold mb-4">学習項目アップロード/追加</h3>
                                    <p className="text-sm text-gray-400 mb-2">Excelファイルをアップロード (●:大項目, ・:小項目)</p>
                                    <input type="file" accept=".xlsx" onChange={handleProgressFileUpload} className="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer"/>
                                    <div className="mt-4 border-t border-gray-700 pt-4 space-y-2">
                                        <h4 className="text-lg font-bold mb-2">手動で追加</h4>
                                        <input type="text" value={newMajorItemName} onChange={(e) => setNewMajorItemName(e.target.value)} placeholder="大項目名" className="w-full p-2 bg-gray-700 rounded-md"/>
                                        <button onClick={handleAddMajorItem} disabled={!currentCertId} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50">大項目を追加</button>
                                        <select value={parentMajorItemId} onChange={(e) => setParentMajorItemId(e.target.value)} className="w-full p-2 bg-gray-700 rounded-md mt-4">
                                            <option value="">親となる大項目を選択...</option>
                                            {Object.entries(data.progress[currentCertId]?.items || {}).map(([key, item]) => <option key={key} value={key}>{item.name}</option>)}
                                        </select>
                                        <input type="text" value={newMinorItemName} onChange={(e) => setNewMinorItemName(e.target.value)} placeholder="小項目名" className="w-full p-2 bg-gray-700 rounded-md"/>
                                        <button onClick={handleAddMinorItem} disabled={!parentMajorItemId} className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50">小項目を追加</button>
                                    </div>
                                </div>
                            </div>
                            <div className="w-full lg:w-2/3 space-y-4">
                                <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                    <h3 className="text-xl font-bold mb-4">{data.certifications.find(c => c.id === currentCertId)?.name || '資格を選択してください'}</h3>
                                    <div className="w-full bg-gray-700 rounded-full h-4 mb-4">
                                        <div className="bg-green-500 h-4 rounded-full text-xs flex items-center justify-center text-white font-bold" style={{ width: `${data.progress[currentCertId] ? (Object.values(data.progress[currentCertId].items || {}).reduce((acc, major) => acc + Object.values(major.subItems || {}).filter(sub => sub.checked).length, 0) / Object.values(data.progress[currentCertId].items || {}).reduce((acc, major) => acc + Object.keys(major.subItems || {}).length, 0) * 100 || 0).toFixed(1) : 0}%` }}>
                                            {data.progress[currentCertId] ? (Object.values(data.progress[currentCertId].items || {}).reduce((acc, major) => acc + Object.values(major.subItems || {}).filter(sub => sub.checked).length, 0) / Object.values(data.progress[currentCertId].items || {}).reduce((acc, major) => acc + Object.keys(major.subItems || {}).length, 0) * 100 || 0).toFixed(1) : 0}%
                                        </div>
                                    </div>
                                    <div className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                                        {Object.entries(data.progress[currentCertId]?.items || {}).map(([majorKey, majorItem]) => (
                                            <div key={majorKey} className="p-2 rounded bg-gray-700/50">
                                                <h5 className="font-bold mb-1">{majorItem.name}</h5>
                                                <div className="pl-4 space-y-1">
                                                    {Object.entries(majorItem.subItems || {}).map(([minorKey, minorItem]) => (
                                                        <label key={minorKey} className="flex items-center space-x-2 cursor-pointer">
                                                            <input type="checkbox" checked={minorItem.checked} onChange={() => handleProgressCheckbox(minorKey, majorKey)} className="form-checkbox h-4 w-4 text-blue-600 bg-gray-900 border-gray-700 rounded focus:ring-blue-500" />
                                                            <span className={`text-gray-300 ${minorItem.checked ? 'line-through text-gray-500' : ''}`}>{minorItem.name}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>}
                        {currentTab === 'tab-3' && <div className="flex flex-col p-4 space-y-4">
                            <div className="bg-gray-800 p-4 rounded-lg shadow-lg w-full max-w-4xl mx-auto">
                                <h3 className="text-xl font-bold mb-4">AI進捗レポート</h3>
                                <p className="text-sm text-gray-400 mb-4">進捗管理タブで資格を選択後、AIがあなたにアドバイスを送ります。</p>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">レポート者（著名人やキャラクター名）</label>
                                    <input type="text" value={reporter} onChange={(e) => setReporter(e.target.value)} placeholder="例：スティーブ・ジョブズ" className="w-full p-2 bg-gray-700 rounded-md"/>
                                </div>
                                <button onClick={generateReport} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled={loadingReport || !currentCertId}>
                                    {loadingReport ? '生成中...' : 'レポートを生成'}
                                </button>
                                {report && <div className="mt-4 p-4 bg-gray-700 rounded-lg whitespace-pre-wrap leading-relaxed" dangerouslySetInnerHTML={{ __html: report.replace(/\n/g, '<br />') }}></div>}
                            </div>
                        </div>}
                    </main>
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>





















