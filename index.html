<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資格取得管理ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
    <div id="root"></div>

    <!-- ライブラリの読み込み -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
    <script src="https://cdn.plot.ly/2.40.0/plotly.min.js"></script>

    <!-- Firebaseの読み込み (npm importの代替) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInAnonymously = signInAnonymously;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
    </script>
    
    <!-- Reactコード -->
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const uuidv4 = window.uuidv4;
        // Firebaseのグローバル変数を使用
        const initializeApp = window.initializeApp;
        const getAuth = window.getAuth;
        const signInWithCustomToken = window.signInWithCustomToken;
        const onAuthStateChanged = window.onAuthStateChanged;
        const signInAnonymously = window.signInAnonymously;
        const getFirestore = window.getFirestore;
        const doc = window.doc;
        const setDoc = window.setDoc;
        const onSnapshot = window.onSnapshot;
        const Plotly = window.Plotly;

        const App = () => {
          const [data, setData] = useState({
            certifications: [],
            progress: {},
          });
          const [currentTab, setCurrentTab] = useState('tab-1');
          const [editingCert, setEditingCert] = useState(null);
          const [currentCertId, setCurrentCertId] = useState(null);
          const [certForm, setCertForm] = useState({
            name: '',
            difficulty: 1,
            necessity: 1,
            gai: 1,
          });
          const [loading, setLoading] = useState(false);
          const [report, setReport] = useState('');
          const [reporter, setReporter] = useState('');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [modalMessage, setModalMessage] = useState('');
          const [modalAction, setModalAction] = useState(null);
          const [plotlyLoaded, setPlotlyLoaded] = useState(false);
          const [firebaseApp, setFirebaseApp] = useState(null);
          const [db, setDb] = useState(null);
          const [userId, setUserId] = useState(null);
          const [showUserId, setShowUserId] = useState(false);
          const [newItemName, setNewItemName] = useState('');
        
          useEffect(() => {
            const initializeFirebase = async () => {
              try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const firestore = getFirestore(app);
                setFirebaseApp(app);
                setDb(firestore);
        
                if (typeof __initial_auth_token !== 'undefined') {
                  await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                  await signInAnonymously(auth);
                }
        
                onAuthStateChanged(auth, (user) => {
                  if (user) {
                    setUserId(user.uid);
                  } else {
                    setUserId(null);
                  }
                });
              } catch (e) {
                console.error("Firebase initialization failed:", e);
              }
            };
            initializeFirebase();
          }, []);
        
          useEffect(() => {
            if (!db || !userId) return;
        
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
        
            const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
              if (docSnap.exists()) {
                const storedData = docSnap.data();
                setData(prevData => ({
                  ...prevData,
                  certifications: JSON.parse(storedData.certifications || '[]'),
                  progress: JSON.parse(storedData.progress || '{}'),
                }));
              } else {
                setData({ certifications: [], progress: {} });
              }
            });
        
            return () => unsubscribe();
          }, [db, userId]);
        
          const saveDataToFirestore = useCallback(async (newData) => {
            if (!db || !userId) return;
        
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            
            await setDoc(userDocRef, {
              certifications: JSON.stringify(newData.certifications),
              progress: JSON.stringify(newData.progress),
            }, { merge: true });
          }, [db, userId]);
        
          useEffect(() => {
            const loadPlotly = async () => {
              try {
                if (window.Plotly) {
                    setPlotlyLoaded(true);
                }
              } catch (e) {
                console.error("Plotly.js load failed:", e);
              }
            };
            if (!plotlyLoaded) {
              loadPlotly();
            }
          }, [plotlyLoaded]);
        
          useEffect(() => {
            if (editingCert) {
              setCertForm({
                name: editingCert.name,
                difficulty: editingCert.difficulty,
                necessity: editingCert.necessity,
                gai: editingCert.gai,
              });
            } else {
              setCertForm({
                name: '',
                difficulty: 1,
                necessity: 1,
                gai: 1,
              });
            }
          }, [editingCert]);
        
          const openModal = (message, action) => {
            setModalMessage(message);
            setModalAction(() => action);
            setIsModalOpen(true);
          };
        
          const closeModal = () => {
            setIsModalOpen(false);
            setModalMessage('');
            setModalAction(null);
          };
        
          const handleFormChange = (e) => {
            const { name, value } = e.target;
            setCertForm((prevForm) => ({ ...prevForm, [name]: value }));
          };
        
          const handleAddUpdateCert = async () => {
            const newCert = {
              id: editingCert ? editingCert.id : uuidv4(),
              ...certForm,
              difficulty: Number(certForm.difficulty),
              necessity: Number(certForm.necessity),
              gai: Number(certForm.gai),
            };
        
            let updatedCertifications;
            if (editingCert) {
              updatedCertifications = data.certifications.map((c) =>
                c.id === newCert.id ? newCert : c
              );
              setEditingCert(null);
            } else {
              updatedCertifications = [...data.certifications, newCert];
            }
            
            const newData = { ...data, certifications: updatedCertifications };
            setData(newData);
            await saveDataToFirestore(newData);
            setCertForm({ name: '', difficulty: 1, necessity: 1, gai: 1 });
          };
        
          const handleDeleteCert = (id) => {
            openModal('この資格情報を削除してもよろしいですか？', async () => {
              const updatedCertifications = data.certifications.filter((c) => c.id !== id);
              const updatedProgress = { ...data.progress };
              delete updatedProgress[id];
              const newData = { certifications: updatedCertifications, progress: updatedProgress };
              setData(newData);
              await saveDataToFirestore(newData);
              closeModal();
            });
          };
        
          const renderScatterPlot = useCallback(() => {
            if (!plotlyLoaded || !window.Plotly) return;
            const df = data.certifications;
            if (df.length === 0) return;
        
            const plotData = [
              {
                x: df.map((c) => c.difficulty),
                y: df.map((c) => c.necessity),
                z: df.map((c) => c.gai),
                mode: 'markers',
                type: 'scatter3d',
                marker: {
                  size: df.map((c) => c.gai),
                  color: df.map((c) => c.gai),
                  colorscale: 'Cividis',
                  colorbar: { title: 'やりがい' },
                },
                text: df.map((c) => c.name),
                hoverinfo: 'text',
              },
            ];
        
            const layout = {
              height: '100%',
              paper_bgcolor: 'transparent',
              plot_bgcolor: 'transparent',
              margin: { l: 0, r: 0, b: 0, t: 0 },
              scene: {
                xaxis: { title: '難易度', range: [0, 6], showgrid: true, showbackground: false },
                yaxis: { title: '必要性', range: [0, 6], showgrid: true, showbackground: false },
                zaxis: { title: 'やりがい', range: [0, 11], showgrid: true, showbackground: false },
                aspectratio: { x: 1, y: 1, z: 1 },
              },
            };
        
            Plotly.newPlot('scatter-plot', plotData, layout, { responsive: true });
          }, [data.certifications, plotlyLoaded]);
        
          useEffect(() => {
            if (document.getElementById('scatter-plot') && plotlyLoaded) {
              renderScatterPlot();
            }
          }, [renderScatterPlot, plotlyLoaded]);
        
          const handleCertFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
        
            const reader = new FileReader();
            reader.onload = async (event) => {
              const result = event.target.result;
              try {
                const parsedData = JSON.parse(result);
                if (Array.isArray(parsedData) && parsedData.length > 0) {
                  const certifications = parsedData.map(cert => ({
                    id: uuidv4(),
                    name: cert.name,
                    difficulty: Number(cert.difficulty),
                    necessity: Number(cert.necessity),
                    gai: Number(cert.gai),
                  }));
                  const newData = { ...data, certifications };
                  setData(newData);
                  await saveDataToFirestore(newData);
                } else {
                  openModal('無効なファイル形式です。JSON形式のデータをアップロードしてください。');
                }
              } catch (error) {
                openModal('ファイルの読み込み中にエラーが発生しました。JSON形式のデータか確認してください。');
              }
            };
            reader.readAsText(file);
          };
          
          const handleProgressFileUpload = async (e) => {
            openModal("この機能は現在利用できません。学習項目は手動で追加してください。");
          };
        
          const handleProgressCheckbox = async (itemId) => {
            const updatedProgress = { ...data.progress };
            const currentCert = updatedProgress[currentCertId] || {};
            if (currentCert.items) {
              currentCert.items = {
                ...currentCert.items,
                [itemId]: {
                  ...currentCert.items[itemId],
                  checked: !currentCert.items[itemId].checked,
                },
              };
            }
            const newData = { ...data, progress: updatedProgress };
            setData(newData);
            await saveDataToFirestore(newData);
          };
        
          const generateReport = async () => {
            setLoading(true);
            try {
              const certInfo = data.certifications.find(c => c.id === currentCertId);
              const progressData = data.progress[currentCertId];
        
              if (!certInfo || !progressData || !progressData.items) {
                setReport('進捗データが不完全です。');
                setLoading(false);
                return;
              }
              const totalMinorItems = Object.values(progressData.items).filter(i => i.type === 'minor').length;
              const checkedMinorItems = Object.values(progressData.items).filter(i => i.type === 'minor' && i.checked).length;
              const progressPercent = totalMinorItems > 0 ? (checkedMinorItems / totalMinorItems) * 100 : 0;
              const certName = certInfo.name;
        
              const prompt = `
              以下の学習進捗状況について、${reporter}の特徴になりきって、進捗評価とモチベーションを高めるためのアドバイスをしてください。
              進捗状況：
              - 学習中の資格：${certName}
              - 全学習項目数：${totalMinorItems}
              - 完了した項目数：${checkedMinorItems}
              - 進捗率：${progressPercent.toFixed(1)}%
              `;
        
              let chatHistory = [];
              chatHistory.push({ role: "user", parts: [{ text: prompt }] });
              const payload = { contents: chatHistory };
              const apiKey = "" 
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              const result = await response.json();
              const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'レポート生成に失敗しました。';
              setReport(text);
            } catch (error) {
              setReport(`レポート生成中にエラーが発生しました: ${error.message}`);
            }
            setLoading(false);
          };
          
          const handleAddProgressItem = async (itemName, itemType) => {
            if (!currentCertId) {
              openModal("進捗を追加する前に、資格を選択してください。");
              return;
            }
        
            const newProgressItem = {
              name: itemName,
              checked: false,
              type: itemType,
            };
            
            const updatedProgress = { ...data.progress };
            const currentCertProgress = updatedProgress[currentCertId] || { items: {} };
            const newItems = {
              ...currentCertProgress.items,
              [uuidv4()]: newProgressItem,
            };
            currentCertProgress.items = newItems;
            updatedProgress[currentCertId] = currentCertProgress;
        
            const newData = { ...data, progress: updatedProgress };
            setData(newData);
            await saveDataToFirestore(newData);
          };
          
          const renderTab1 = () => {
            const df = data.certifications;
            return (
              <div className="flex flex-col lg:flex-row p-4 space-y-4 lg:space-y-0 lg:space-x-4">
                <div className="w-full lg:w-1/3 space-y-4">
                  <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold mb-4">JSONファイルから資格情報をアップロード</h3>
                    <p className="text-sm text-gray-400 mb-2">
                      {`JSON形式のデータファイルをアップロードしてください。形式は'[{"name": "資格名", "difficulty": 3, "necessity": 4, "gai": 7}, ...]'です。`}
                    </p>
                    <input
                      type="file"
                      accept=".json"
                      onChange={handleCertFileUpload}
                      className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"
                    />
                  </div>
                  <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold mb-4">資格情報の追加/編集</h3>
                    <div className="mb-4">
                      <label className="block text-sm font-medium mb-1">資格名</label>
                      <input
                        type="text"
                        name="name"
                        value={certForm.name}
                        onChange={handleFormChange}
                        placeholder="例：基本情報技術者試験"
                        className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium mb-1">難易度 (1-5)</label>
                      <input
                        type="number"
                        name="difficulty"
                        value={certForm.difficulty}
                        onChange={handleFormChange}
                        min="1"
                        max="5"
                        step="1"
                        className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium mb-1">必要性 (1-5)</label>
                      <input
                        type="number"
                        name="necessity"
                        value={certForm.necessity}
                        onChange={handleFormChange}
                        min="1"
                        max="5"
                        step="1"
                        className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium mb-1">やりがい (1-10)</label>
                      <input
                        type="number"
                        name="gai"
                        value={certForm.gai}
                        onChange={handleFormChange}
                        min="1"
                        max="10"
                        step="0.1"
                        className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <button
                      onClick={handleAddUpdateCert}
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
                    >
                      {editingCert ? '更新' : '追加'}
                    </button>
                    {editingCert && (
                      <button
                        onClick={() => setEditingCert(null)}
                        className="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition-colors duration-200"
                      >
                        キャンセル
                      </button>
                    )}
                  </div>
                </div>
        
                <div className="w-full lg:w-2/3 space-y-4">
                  <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold mb-4">資格取得の優先順位（3D散布図）</h3>
                    <div id="scatter-plot" className="w-full h-[60vh]"></div>
                  </div>
                  <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold mb-4">資格一覧</h3>
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-700">
                        <thead className="bg-gray-700">
                          <tr>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">資格名</th>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">難易度</th>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">必要性</th>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">やりがい</th>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">アクション</th>
                          </tr>
                        </thead>
                        <tbody className="bg-gray-800 divide-y divide-gray-700">
                          {df.length === 0 ? (
                            <tr>
                              <td colSpan="5" className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium text-gray-400">
                                資格情報が登録されていません。
                              </td>
                            </tr>
                          ) : (
                            df.map((cert) => (
                              <tr key={cert.id} className="hover:bg-gray-700 transition-colors duration-150">
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{cert.name}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{cert.difficulty}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{cert.necessity}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{cert.gai}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                  <button onClick={() => setEditingCert(cert)} className="text-indigo-400 hover:text-indigo-600 mr-4">編集</button>
                                  <button onClick={() => handleDeleteCert(cert.id)} className="text-red-400 hover:text-red-600">削除</button>
                                </td>
                              </tr>
                            ))
                          )}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            );
          };
          
          const renderTab2 = () => {
            const certs = data.certifications;
            const currentCertProgress = data.progress[currentCertId] || {};
            const totalMinorItems = Object.values(currentCertProgress.items || {}).filter(i => i.type === 'minor').length;
            const checkedMinorItems = Object.values(currentCertProgress.items || {}).filter(i => i.type === 'minor' && i.checked).length;
            const progressPercent = totalMinorItems > 0 ? (checkedMinorItems / totalMinorItems) * 100 : 0;
            
            const handleAddItem = async (itemName) => {
              if (itemName.trim() === '') return;
              await handleAddProgressItem(itemName.trim(), 'minor');
            };
        
            return (
              <div className="flex flex-col lg:flex-row p-4 space-y-4 lg:space-y-0 lg:space-x-4">
                <div className="w-full lg:w-1/3 space-y-4">
                  <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold mb-4">学習中の資格設定</h3>
                    <div className="mb-4">
                      <label className="block text-sm font-medium mb-1">学習中の資格</label>
                      <select
                        className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={currentCertId || ''}
                        onChange={(e) => setCurrentCertId(e.target.value)}
                      >
                        <option value="">資格を選択...</option>
                        {certs.map((cert) => (
                          <option key={cert.id} value={cert.id}>
                            {cert.name}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium mb-1">目標取得日</label>
                      <input
                        type="date"
                        value={currentCertProgress.targetDate || ''}
                        onChange={async (e) => {
                            const updatedProgress = { ...data.progress, [currentCertId]: { ...currentCertProgress, targetDate: e.target.value } };
                            const newData = { ...data, progress: updatedProgress };
                            setData(newData);
                            await saveDataToFirestore(newData);
                        }}
                        className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  </div>
                  <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold mb-4">学習項目追加</h3>
                    <div className="flex space-x-2">
                      <input
                        type="text"
                        value={newItemName}
                        onChange={(e) => setNewItemName(e.target.value)}
                        placeholder="新しい学習項目"
                        className="flex-grow p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <button
                        onClick={() => handleAddItem(newItemName)}
                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
                      >
                        追加
                      </button>
                    </div>
                    <button
                      onClick={() => openModal("進捗状況をリセットしますか？", async () => {
                        const updatedProgress = { ...data.progress, [currentCertId]: { items: {} } };
                        const newData = { ...data, progress: updatedProgress };
                        setData(newData);
                        await saveDataToFirestore(newData);
                        closeModal();
                      })}
                      className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-4 transition-colors duration-200"
                    >
                      進捗状況をリセット
                    </button>
                  </div>
                </div>
        
                <div className="w-full lg:w-2/3 space-y-4">
                  <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold mb-4">{data.certifications.find(c => c.id === currentCertId)?.name || '資格を選択してください'}</h3>
                    <div className="w-full bg-gray-700 rounded-full h-4 mb-4">
                      <div className="bg-green-500 h-4 rounded-full text-xs flex items-center justify-center text-white" style={{ width: `${progressPercent}%` }}>
                        {progressPercent.toFixed(1)}%
                      </div>
                    </div>
                    <h4 className="text-lg font-bold mb-2">学習項目一覧</h4>
                    <div className="space-y-2 max-h-[40vh] overflow-y-auto pr-2">
                      {Object.entries(currentCertProgress.items || {}).map(([key, item]) => (
                        <div key={key}>
                          <label className="flex items-center space-x-2">
                            <input type="checkbox" checked={item.checked} onChange={() => handleProgressCheckbox(key)} className="form-checkbox h-4 w-4 text-blue-600 bg-gray-900 border-gray-700 rounded focus:ring-blue-500" />
                            <span className={`text-gray-300 ${item.checked ? 'line-through text-gray-500' : ''}`}>{item.name}</span>
                          </label>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          };
          
          const renderTab3 = () => {
            const certs = data.certifications;
            const currentCertProgress = data.progress[currentCertId] || {};
            const totalMinorItems = Object.values(currentCertProgress.items || {}).filter(i => i.type === 'minor').length;
            const checkedMinorItems = Object.values(currentCertProgress.items || {}).filter(i => i.type === 'minor' && i.checked).length;
            const progressPercent = totalMinorItems > 0 ? (checkedMinorItems / totalMinorItems) * 100 : 0;
            return (
              <div className="flex flex-col p-4 space-y-4">
                <div className="bg-gray-800 p-4 rounded-lg shadow-lg w-full">
                  <h3 className="text-xl font-bold mb-4">AI進捗レポート</h3>
                  <p className="text-sm text-gray-400 mb-4">進捗状況に基づいて、AIがあなたにアドバイスを送ります。</p>
                  <div className="mb-4">
                    <label className="block text-sm font-medium mb-1">レポート者（著名人）</label>
                    <input
                      type="text"
                      value={reporter}
                      onChange={(e) => setReporter(e.target.value)}
                      placeholder="例：スティーブ・ジョブズ"
                      className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <button
                    onClick={generateReport}
                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
                    disabled={loading || !currentCertId}
                  >
                    {loading ? '生成中...' : 'レポートを生成'}
                  </button>
                  {report && (
                    <div className="mt-4 p-4 bg-gray-700 rounded-lg whitespace-pre-wrap">
                      {report}
                    </div>
                  )}
                </div>
              </div>
            );
          };
        
          const renderContent = () => {
            switch (currentTab) {
              case 'tab-1':
                return renderTab1();
              case 'tab-2':
                return renderTab2();
              case 'tab-3':
                return renderTab3();
              default:
                return null;
            }
          };
        
          return (
            <div className="min-h-screen bg-gray-900 text-gray-100 font-sans p-4">
              {isModalOpen && (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                  <div className="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <p className="text-white mb-4">{modalMessage}</p>
                    <div className="flex justify-end space-x-2">
                      {modalAction && (
                        <button
                          onClick={modalAction}
                          className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
                        >
                          はい
                        </button>
                      )}
                      <button
                        onClick={closeModal}
                        className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
                      >
                        {modalAction ? 'キャンセル' : '閉じる'}
                      </button>
                    </div>
                  </div>
                </div>
              )}
              <header className="text-center mb-8">
                <h1 className="text-4xl font-extrabold text-white">資格取得管理ダッシュボード</h1>
                {userId && (
                  <div className="flex items-center justify-center mt-2 text-sm text-gray-400">
                    <button
                      onClick={() => setShowUserId(!showUserId)}
                      className="hover:underline"
                    >
                      ユーザーID {showUserId ? 'を非表示' : 'を表示'}
                    </button>
                    {showUserId && (
                      <span className="ml-2 font-mono text-xs p-1 bg-gray-800 rounded">{userId}</span>
                    )}
                  </div>
                )}
              </header>
              <nav className="mb-8">
                <div className="border-b border-gray-700">
                  <div className="flex justify-center space-x-4">
                    <button
                      className={`py-2 px-4 rounded-t-lg transition-colors duration-200 ${currentTab === 'tab-1' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-700'}`}
                      onClick={() => setCurrentTab('tab-1')}
                    >
                      優先順位付け
                    </button>
                    <button
                      className={`py-2 px-4 rounded-t-lg transition-colors duration-200 ${currentTab === 'tab-2' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-700'}`}
                      onClick={() => setCurrentTab('tab-2')}
                    >
                      進捗管理
                    </button>
                    <button
                      className={`py-2 px-4 rounded-t-lg transition-colors duration-200 ${currentTab === 'tab-3' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-700'}`}
                      onClick={() => setCurrentTab('tab-3')}
                    >
                      レポート
                    </button>
                  </div>
                </div>
              </nav>
              <main className="container mx-auto">
                {renderContent()}
              </main>
            </div>
          );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
