<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資格取得管理ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        /* スクロールバーのスタイル */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
    <div id="root"></div>

    <!-- ライブラリの読み込み -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
    <script src="https://cdn.plot.ly/2.40.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebaseの読み込み -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp,
            getAuth,
            signInWithCustomToken,
            onAuthStateChanged,
            signInAnonymously,
            getFirestore,
            doc,
            setDoc,
            onSnapshot
        };
    </script>
    
    <!-- Reactコード -->
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { v4: uuidv4 } = window;
        const { initializeApp, getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously, getFirestore, doc, setDoc, onSnapshot } = window.firebase;
        const Plotly = window.Plotly;
        const XLSX = window.XLSX;

        const App = () => {
            const [data, setData] = useState({
                certifications: [],
                progress: {},
            });
            const [currentTab, setCurrentTab] = useState('tab-1');
            const [editingCert, setEditingCert] = useState(null);
            const [currentCertId, setCurrentCertId] = useState(null);
            const [certForm, setCertForm] = useState({
                name: '',
                difficulty: 1,
                necessity: 1,
                gai: 1,
            });
            const [loading, setLoading] = useState(false);
            const [report, setReport] = useState('');
            const [reporter, setReporter] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalMessage, setModalMessage] = useState('');
            const [modalAction, setModalAction] = useState(null);
            const [plotlyLoaded, setPlotlyLoaded] = useState(false);
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [showUserId, setShowUserId] = useState(false);
            
            // State for Tab 2 inputs
            const [newMajorItemName, setNewMajorItemName] = useState('');
            const [newMinorItemName, setNewMinorItemName] = useState('');
            const [parentMajorItemId, setParentMajorItemId] = useState('');


            useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        setDb(firestore);
            
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
            
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                setUserId(user.uid);
                            } else {
                                setUserId(null);
                            }
                        });
                    } catch (e) {
                        console.error("Firebase initialization failed:", e);
                    }
                };
                initializeFirebase();
            }, []);
            
            useEffect(() => {
                if (!db || !userId) return;
            
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            
                const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const storedData = docSnap.data();
                        setData({
                            certifications: JSON.parse(storedData.certifications || '[]'),
                            progress: JSON.parse(storedData.progress || '{}'),
                        });
                    } else {
                        setData({ certifications: [], progress: {} });
                    }
                });
            
                return () => unsubscribe();
            }, [db, userId]);
            
            const saveDataToFirestore = useCallback(async (newData) => {
                if (!db || !userId) return;
            
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                
                await setDoc(userDocRef, {
                    certifications: JSON.stringify(newData.certifications),
                    progress: JSON.stringify(newData.progress),
                }, { merge: true });
            }, [db, userId]);
            
            useEffect(() => {
                if (window.Plotly) {
                    setPlotlyLoaded(true);
                }
            }, []);
            
            useEffect(() => {
                if (editingCert) {
                    setCertForm({
                        name: editingCert.name,
                        difficulty: editingCert.difficulty,
                        necessity: editingCert.necessity,
                        gai: editingCert.gai,
                    });
                } else {
                    setCertForm({ name: '', difficulty: 1, necessity: 1, gai: 1 });
                }
            }, [editingCert]);
            
            const openModal = (message, action = null) => {
                setModalMessage(message);
                setModalAction(() => action);
                setIsModalOpen(true);
            };
            
            const closeModal = () => {
                setIsModalOpen(false);
                setModalMessage('');
                setModalAction(null);
            };
            
            const handleFormChange = (e) => {
                const { name, value } = e.target;
                setCertForm((prevForm) => ({ ...prevForm, [name]: value }));
            };
            
            const handleAddUpdateCert = async () => {
                if (!certForm.name.trim()) {
                    openModal('資格名を入力してください。');
                    return;
                }
                const newCert = {
                    id: editingCert ? editingCert.id : uuidv4(),
                    ...certForm,
                    difficulty: Number(certForm.difficulty),
                    necessity: Number(certForm.necessity),
                    gai: Number(certForm.gai),
                };
            
                let updatedCertifications;
                if (editingCert) {
                    updatedCertifications = data.certifications.map((c) =>
                        c.id === newCert.id ? newCert : c
                    );
                    setEditingCert(null);
                } else {
                    updatedCertifications = [...data.certifications, newCert];
                }
                
                const newData = { ...data, certifications: updatedCertifications };
                setData(newData);
                await saveDataToFirestore(newData);
                setCertForm({ name: '', difficulty: 1, necessity: 1, gai: 1 });
            };
            
            const handleDeleteCert = (id) => {
                openModal('この資格情報を削除してもよろしいですか？', async () => {
                    const updatedCertifications = data.certifications.filter((c) => c.id !== id);
                    const updatedProgress = { ...data.progress };
                    delete updatedProgress[id];
                    const newData = { certifications: updatedCertifications, progress: updatedProgress };
                    setData(newData);
                    await saveDataToFirestore(newData);
                    if (currentCertId === id) {
                        setCurrentCertId(null);
                    }
                    closeModal();
                });
            };
            
            const renderScatterPlot = useCallback(() => {
                if (!plotlyLoaded || !document.getElementById('scatter-plot')) return;
                const df = data.certifications.filter(cert => cert.name && !isNaN(cert.difficulty) && !isNaN(cert.necessity) && !isNaN(cert.gai));
                
                const plotData = [
                    {
                        x: df.map((c) => c.difficulty),
                        y: df.map((c) => c.necessity),
                        z: df.map((c) => c.gai),
                        mode: 'markers+text',
                        type: 'scatter3d',
                        marker: {
                            size: df.map((c) => c.gai + 2),
                            color: df.map((c) => c.gai),
                            colorscale: 'Viridis',
                            colorbar: { title: 'やりがい' },
                        },
                        text: df.map((c) => c.name),
                        textposition: 'top center',
                        hoverinfo: 'text',
                    },
                ];
            
                const layout = {
                    title: '資格ポートフォリオ',
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    font: { color: '#f3f4f6' },
                    margin: { l: 0, r: 0, b: 0, t: 40 },
                    scene: {
                        xaxis: { title: '難易度', range: [0, 6], showgrid: true, gridcolor: '#4b5563', showbackground: false, zerolinecolor: '#6b7280' },
                        yaxis: { title: '必要性', range: [0, 6], showgrid: true, gridcolor: '#4b5563', showbackground: false, zerolinecolor: '#6b7280' },
                        zaxis: { title: 'やりがい', range: [0, 11], showgrid: true, gridcolor: '#4b5563', showbackground: false, zerolinecolor: '#6b7280' },
                        aspectratio: { x: 1, y: 1, z: 1 },
                        camera: {
                            eye: {x: 1.5, y: 1.5, z: 1.5}
                        }
                    },
                };
            
                Plotly.newPlot('scatter-plot', plotData, layout, { responsive: true });
            }, [data.certifications, plotlyLoaded]);
            
            useEffect(() => {
                if (currentTab === 'tab-1') {
                    renderScatterPlot();
                }
            }, [data.certifications, currentTab, renderScatterPlot]);
            
            const handleCertFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
            
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const result = event.target.result;
                    try {
                        let certifications = [];
                        if (file.name.endsWith('.json')) {
                            const parsedData = JSON.parse(result);
                            if (Array.isArray(parsedData)) {
                                certifications = parsedData.map(cert => ({
                                    id: uuidv4(),
                                    name: cert.name || '',
                                    difficulty: Number(cert.difficulty) || 1,
                                    necessity: Number(cert.necessity) || 1,
                                    gai: Number(cert.gai) || 1,
                                }));
                            }
                        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                            const workbook = XLSX.read(result, { type: 'binary' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            // --- 変更点 ---
                            // 6行目(index:5)をヘッダーとしてデータを読み込む
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 5 }); 
                            
                            certifications = jsonData.map(row => ({
                                id: uuidv4(),
                                name: row.name || row.資格名 || '',
                                difficulty: Number(row.difficulty) || Number(row.難易度) || 1,
                                necessity: Number(row.necessity) || Number(row.必要性) || 1,
                                gai: Number(row.gai) || Number(row.やりがい) || 1,
                            })).filter(cert => cert.name);
                        }

                        if (certifications.length > 0) {
                            const newData = { ...data, certifications };
                            setData(newData);
                            await saveDataToFirestore(newData);
                            openModal('ファイルのアップロードが完了しました！');
                        } else {
                            openModal('無効なファイル形式、または読み込むデータが含まれていません。');
                        }
                    } catch (error) {
                        console.error(error);
                        openModal('ファイルの読み込み中にエラーが発生しました。ファイル形式か中身を確認してください。');
                    }
                };
                if (file.name.endsWith('.json')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsBinaryString(file);
                }
            };
            
            const handleProgressFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file || !currentCertId) {
                    openModal("先に学習中の資格を選択してください。");
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const fileData = event.target.result;
                    try {
                        const workbook = XLSX.read(fileData, { type: 'binary' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        const items = {};
                        let currentMajorItemKey = null;

                        jsonData.forEach(row => {
                            const cellValue = row[0];
                            if (typeof cellValue === 'string' && cellValue.trim() !== '') {
                                const trimmedValue = cellValue.trim();
                                if (trimmedValue.startsWith('●')) {
                                    currentMajorItemKey = uuidv4();
                                    items[currentMajorItemKey] = {
                                        name: trimmedValue.substring(1).trim(),
                                        checked: false,
                                        type: 'major',
                                        subItems: {}
                                    };
                                } else if ((trimmedValue.startsWith('・') || trimmedValue.startsWith('-')) && currentMajorItemKey) {
                                    const subItemKey = uuidv4();
                                    items[currentMajorItemKey].subItems[subItemKey] = {
                                        name: trimmedValue.substring(1).trim(),
                                        checked: false,
                                        type: 'minor'
                                    };
                                }
                            }
                        });

                        const updatedProgress = { ...data.progress, [currentCertId]: { ...data.progress[currentCertId], items } };
                        const newData = { ...data, progress: updatedProgress };
                        setData(newData);
                        await saveDataToFirestore(newData);
                        openModal('学習項目のアップロードが完了しました！');
                    } catch (error) {
                        console.error(error);
                        openModal('ファイルの読み込み中にエラーが発生しました。Excel形式のファイルか確認してください。');
                    }
                };
                reader.readAsBinaryString(file);
            };
            
            const handleProgressCheckbox = async (minorId, majorId) => {
                const updatedProgress = { ...data.progress };
                const certProgress = updatedProgress[currentCertId];
                
                if (certProgress && certProgress.items && certProgress.items[majorId] && certProgress.items[majorId].subItems[minorId]) {
                    // Toggle minor item
                    certProgress.items[majorId].subItems[minorId].checked = !certProgress.items[majorId].subItems[minorId].checked;
                    
                    // Check if all sub-items are checked to toggle the major item
                    const allSubItemsChecked = Object.values(certProgress.items[majorId].subItems).every(item => item.checked);
                    certProgress.items[majorId].checked = allSubItemsChecked;
                    
                    const newData = { ...data, progress: updatedProgress };
                    setData(newData);
                    await saveDataToFirestore(newData);
                }
            };

            const handleAddMajorItem = async () => {
                if (!currentCertId || !newMajorItemName.trim()) {
                    openModal("資格を選択し、項目名を入力してください。");
                    return;
                }
                const updatedProgress = { ...data.progress };
                const currentCertProgress = updatedProgress[currentCertId] || { items: {} };
                const newMajorKey = uuidv4();
                currentCertProgress.items[newMajorKey] = {
                    name: newMajorItemName.trim(),
                    checked: false,
                    type: 'major',
                    subItems: {}
                };
                updatedProgress[currentCertId] = currentCertProgress;

                const newData = { ...data, progress: updatedProgress };
                setData(newData);
                await saveDataToFirestore(newData);
                setNewMajorItemName('');
            };

            const handleAddMinorItem = async () => {
                if (!currentCertId || !newMinorItemName.trim() || !parentMajorItemId) {
                    openModal("大項目を選択し、小項目名を入力してください。");
                    return;
                }
                const updatedProgress = { ...data.progress };
                const currentCertProgress = updatedProgress[currentCertId];

                if (currentCertProgress && currentCertProgress.items[parentMajorItemId]) {
                    const newMinorKey = uuidv4();
                    currentCertProgress.items[parentMajorItemId].subItems[newMinorKey] = {
                        name: newMinorItemName.trim(),
                        checked: false,
                        type: 'minor'
                    };
                    updatedProgress[currentCertId] = currentCertProgress;
                    const newData = { ...data, progress: updatedProgress };
                    setData(newData);
                    await saveDataToFirestore(newData);
                    setNewMinorItemName('');
                }
            };
            
            const generateReport = async () => {
                setLoading(true);
                setReport('');
                try {
                    const certInfo = data.certifications.find(c => c.id === currentCertId);
                    const progressData = data.progress[currentCertId];
                
                    if (!certInfo || !progressData || !progressData.items) {
                        setReport('進捗データが不完全です。レポートを生成できません。');
                        setLoading(false);
                        return;
                    }
                    
                    let totalMinorItems = 0;
                    let checkedMinorItems = 0;
                    
                    Object.values(progressData.items).forEach(majorItem => {
                        if (majorItem.subItems) {
                            totalMinorItems += Object.keys(majorItem.subItems).length;
                            checkedMinorItems += Object.values(majorItem.subItems).filter(item => item.checked).length;
                        }
                    });

                    const progressPercent = totalMinorItems > 0 ? (checkedMinorItems / totalMinorItems) * 100 : 0;
                    const certName = certInfo.name;
                    
                    const prompt = `あなたは「${reporter || '熱血コーチ'}」です。以下の学習進捗状況について、そのキャラクターになりきって、学習者を力強く励ます評価と、次に取り組むべき具体的なアクションを提案してください。レポートは情熱的かつ分かりやすく、markdown形式で記述してください。
### 学習進捗レポート
- **資格名**: ${certName}
- **総学習項目数**: ${totalMinorItems}
- **完了項目数**: ${checkedMinorItems}
- **進捗率**: ${progressPercent.toFixed(1)}%
`;
                
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'レポート生成に失敗しました。';
                    setReport(text);
                } catch (error) {
                    setReport(`レポート生成中にエラーが発生しました: ${error.message}`);
                }
                setLoading(false);
            };

            const renderTab1 = () => (
                <div className="flex flex-col lg:flex-row p-4 gap-4">
                    <div className="w-full lg:w-1/3 space-y-4">
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-4">資格情報をアップロード</h3>
                            {/* --- 変更点 --- */}
                            <p className="text-sm text-gray-400 mb-2">
                                Excel(.xlsx)またはJSON(.json)をアップロード。<br/>
                                <b>Excelの場合、6行目にヘッダーを設置してください。</b><br/>
                                (例: name, difficulty, necessity, gai)<br/>
                                データは7行目から読み込まれます。
                            </p>
                            <input
                                type="file"
                                accept=".json,.xlsx,.xls"
                                onChange={handleCertFileUpload}
                                className="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer"
                            />
                        </div>
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-4">{editingCert ? '資格情報の編集' : '資格情報の追加'}</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">資格名</label>
                                    <input type="text" name="name" value={certForm.name} onChange={handleFormChange} placeholder="例：基本情報技術者試験" className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">難易度 (1-5)</label>
                                    <input type="number" name="difficulty" value={certForm.difficulty} onChange={handleFormChange} min="1" max="5" step="1" className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">必要性 (1-5)</label>
                                    <input type="number" name="necessity" value={certForm.necessity} onChange={handleFormChange} min="1" max="5" step="1" className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">やりがい (1-10)</label>
                                    <input type="number" name="gai" value={certForm.gai} onChange={handleFormChange} min="1" max="10" step="0.1" className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <button onClick={handleAddUpdateCert} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                                    {editingCert ? '更新' : '追加'}
                                </button>
                                {editingCert && (
                                    <button onClick={() => setEditingCert(null)} className="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2 transition-colors duration-200">
                                        キャンセル
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
            
                    <div className="w-full lg:w-2/3 space-y-4">
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-4">資格取得の優先順位（3D散布図）</h3>
                            <div id="scatter-plot" className="w-full h-[60vh] min-h-[400px]"></div>
                        </div>
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-4">資格一覧</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-700">
                                    <thead className="bg-gray-700">
                                        <tr>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">資格名</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">難易度</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">必要性</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">やりがい</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">アクション</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-gray-800 divide-y divide-gray-700">
                                        {data.certifications.length === 0 ? (
                                            <tr>
                                                <td colSpan="5" className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium text-gray-400">資格情報が登録されていません。</td>
                                            </tr>
                                        ) : (
                                            data.certifications.map((cert) => (
                                                <tr key={cert.id} className="hover:bg-gray-700 transition-colors duration-150">
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{cert.name}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{cert.difficulty}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{cert.necessity}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{cert.gai}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <button onClick={() => setEditingCert(cert)} className="text-indigo-400 hover:text-indigo-600 mr-4">編集</button>
                                                        <button onClick={() => handleDeleteCert(cert.id)} className="text-red-400 hover:text-red-600">削除</button>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
            
            const renderTab2 = () => {
                const certs = data.certifications;
                const currentCertProgress = data.progress[currentCertId] || {};
                
                let totalMinorItems = 0;
                let checkedMinorItems = 0;
                
                Object.values(currentCertProgress.items || {}).forEach(majorItem => {
                    if (majorItem.subItems) {
                        totalMinorItems += Object.keys(majorItem.subItems).length;
                        checkedMinorItems += Object.values(majorItem.subItems).filter(item => item.checked).length;
                    }
                });
                const progressPercent = totalMinorItems > 0 ? (checkedMinorItems / totalMinorItems) * 100 : 0;
                
                return (
                    <div className="flex flex-col lg:flex-row p-4 gap-4">
                        <div className="w-full lg:w-1/3 space-y-4">
                            <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                <h3 className="text-xl font-bold mb-4">学習中の資格設定</h3>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">学習中の資格</label>
                                    <select
                                        className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={currentCertId || ''}
                                        onChange={(e) => setCurrentCertId(e.target.value)}
                                    >
                                        <option value="">資格を選択...</option>
                                        {certs.map((cert) => (
                                            <option key={cert.id} value={cert.id}>{cert.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">目標取得日</label>
                                    <input
                                        type="date"
                                        value={currentCertProgress.targetDate || ''}
                                        onChange={async (e) => {
                                            if (!currentCertId) return;
                                            const updatedProgress = { ...data.progress, [currentCertId]: { ...currentCertProgress, targetDate: e.target.value } };
                                            const newData = { ...data, progress: updatedProgress };
                                            setData(newData);
                                            await saveDataToFirestore(newData);
                                        }}
                                        className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>
                            <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                <h3 className="text-xl font-bold mb-4">学習項目アップロード/追加</h3>
                                <p className="text-sm text-gray-400 mb-2">Excelファイルをアップロードします。（●:大項目, ・:小項目）</p>
                                <input type="file" accept=".xlsx" onChange={handleProgressFileUpload} className="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer"/>
                                <div className="mt-4 border-t border-gray-700 pt-4">
                                    <h4 className="text-lg font-bold mb-2">学習項目を手動で追加</h4>
                                    <div className="space-y-2">
                                        <input type="text" value={newMajorItemName} onChange={(e) => setNewMajorItemName(e.target.value)} placeholder="大項目名" className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        <button onClick={handleAddMajorItem} disabled={!currentCertId} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed">大項目を追加</button>
                                        
                                        <select className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 mt-4" value={parentMajorItemId} onChange={(e) => setParentMajorItemId(e.target.value)}>
                                            <option value="">小項目を追加する大項目を選択...</option>
                                            {Object.entries(currentCertProgress.items || {}).map(([key, item]) => (
                                                <option key={key} value={key}>{item.name}</option>
                                            ))}
                                        </select>
                                        <input type="text" value={newMinorItemName} onChange={(e) => setNewMinorItemName(e.target.value)} placeholder="小項目名" className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        <button onClick={handleAddMinorItem} disabled={!parentMajorItemId} className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed">小項目を追加</button>
                                    </div>
                                </div>
                                <button
                                    onClick={() => openModal("現在の資格の進捗状況をすべてリセットしますか？", async () => {
                                        if (!currentCertId) return;
                                        const updatedProgress = { ...data.progress, [currentCertId]: { items: {}, targetDate: data.progress[currentCertId]?.targetDate || '' } };
                                        const newData = { ...data, progress: updatedProgress };
                                        setData(newData);
                                        await saveDataToFirestore(newData);
                                        closeModal();
                                    })}
                                    className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-4 transition-colors duration-200"
                                >
                                    進捗状況をリセット
                                </button>
                            </div>
                        </div>
                
                        <div className="w-full lg:w-2/3 space-y-4">
                            <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                <h3 className="text-xl font-bold mb-4">{certs.find(c => c.id === currentCertId)?.name || '資格を選択してください'}</h3>
                                <div className="w-full bg-gray-700 rounded-full h-4 mb-4">
                                    <div className="bg-green-500 h-4 rounded-full text-xs flex items-center justify-center text-white font-bold" style={{ width: `${progressPercent}%` }}>
                                        {progressPercent > 10 && `${progressPercent.toFixed(1)}%`}
                                    </div>
                                </div>
                                <h4 className="text-lg font-bold mb-2">学習項目一覧</h4>
                                <div className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                                    {Object.entries(currentCertProgress.items || {}).map(([majorKey, majorItem]) => (
                                        <div key={majorKey} className="p-2 rounded bg-gray-700/50">
                                            <h5 className="font-bold mb-1">{majorItem.name}</h5>
                                            <div className="pl-4 space-y-1">
                                                {Object.entries(majorItem.subItems || {}).map(([minorKey, minorItem]) => (
                                                    <label key={minorKey} className="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" checked={minorItem.checked} onChange={() => handleProgressCheckbox(minorKey, majorKey)} className="form-checkbox h-4 w-4 text-blue-600 bg-gray-900 border-gray-700 rounded focus:ring-blue-500" />
                                                        <span className={`text-gray-300 ${minorItem.checked ? 'line-through text-gray-500' : ''}`}>{minorItem.name}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };
            
            const renderTab3 = () => (
                <div className="flex flex-col p-4 space-y-4">
                    <div className="bg-gray-800 p-4 rounded-lg shadow-lg w-full max-w-4xl mx-auto">
                        <h3 className="text-xl font-bold mb-4">AI進捗レポート</h3>
                        <p className="text-sm text-gray-400 mb-4">進捗管理タブで資格を選択後、AIがあなたにアドバイスを送ります。</p>
                        <div className="mb-4">
                            <label className="block text-sm font-medium mb-1">レポート者（著名人やキャラクター名）</label>
                            <input
                                type="text"
                                value={reporter}
                                onChange={(e) => setReporter(e.target.value)}
                                placeholder="例：スティーブ・ジョブズ、ドラえもん"
                                className="w-full p-2 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                        </div>
                        <button
                            onClick={generateReport}
                            className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed"
                            disabled={loading || !currentCertId}
                        >
                            {loading ? '生成中...' : 'レポートを生成'}
                        </button>
                        {report && (
                            <div className="mt-4 p-4 bg-gray-700 rounded-lg whitespace-pre-wrap leading-relaxed">
                                {report}
                            </div>
                        )}
                    </div>
                </div>
            );
            
            const renderContent = () => {
                switch (currentTab) {
                    case 'tab-1': return renderTab1();
                    case 'tab-2': return renderTab2();
                    case 'tab-3': return renderTab3();
                    default: return null;
                }
            };
            
            return (
                <div className="min-h-screen bg-gray-900 text-gray-100 p-4">
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                            <div className="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                                <p className="text-white mb-6">{modalMessage}</p>
                                <div className="flex justify-end space-x-4">
                                    {modalAction && (
                                        <button onClick={modalAction} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                                            はい
                                        </button>
                                    )}
                                    <button onClick={closeModal} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                                        {modalAction ? 'キャンセル' : '閉じる'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    <header className="text-center mb-8">
                        <h1 className="text-4xl font-extrabold text-white" style={{fontFamily: "'Inter', sans-serif"}}>資格取得管理ダッシュボード</h1>
                        {userId && (
                            <div className="flex items-center justify-center mt-2 text-sm text-gray-400">
                                <button onClick={() => setShowUserId(!showUserId)} className="hover:underline">
                                    ユーザーID {showUserId ? 'を非表示' : 'を表示'}
                                </button>
                                {showUserId && (
                                    <span className="ml-2 font-mono text-xs p-1 bg-gray-800 rounded">{userId}</span>
                                )}
                            </div>
                        )}
                    </header>
                    <nav className="mb-8">
                        <div className="border-b border-gray-700">
                            <div className="flex justify-center space-x-4">
                                {['tab-1', 'tab-2', 'tab-3'].map((tabId, index) => (
                                    <button
                                        key={tabId}
                                        className={`py-2 px-4 font-bold rounded-t-lg transition-colors duration-200 ${currentTab === tabId ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-700/50'}`}
                                        onClick={() => setCurrentTab(tabId)}
                                    >
                                        {['優先順位付け', '進捗管理', 'レポート'][index]}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>
                    <main className="container mx-auto">
                        {renderContent()}
                    </main>
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>









