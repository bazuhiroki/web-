<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資格取得管理ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        canvas { display: block; }
        .day-selected { background-color: #4f46e5 !important; color: white !important; }

        /* モーダルのアニメーション */
        @keyframes fade-in-scale {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-fade-in-scale {
            animation: fade-in-scale 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="root" class="h-screen"></div>

    <!-- ライブラリ -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <!-- Reactコード -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const { uuidv4, XLSX, Chart } = window;
        const { jsPDF } = window.jspdf;

        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // 【重要】ご自身のFirebaseプロジェクトの設定情報をこちらに貼り付けてください
        // この部分が正しくないと、"redirect_uri_mismatch" エラーが発生します。
        const firebaseConfig = {
            apiKey: "AIzaSyDUfeARP0PATgGlG17Grqit29-U0ya5vhQ",
            authDomain: "shikaku-dashboard.firebaseapp.com",
            projectId: "shikaku-dashboard",
            storageBucket: "shikaku-dashboard.firebasestorage.app",
            messagingSenderId: "727535626459",
            appId: "1:727535626459:web:aaf0fd5a49df92cc9004fe",
            measurementId: "G-C3V0X55D9X"
        };
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★


        // --- UIコンポーネント ---
        const BubbleChart = ({ data }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            useEffect(() => {
                const currentCanvas = canvasRef.current;
                if (!currentCanvas || typeof Chart === 'undefined') return;
                if (chartRef.current) chartRef.current.destroy();
                const ctx = currentCanvas.getContext('2d');
                const chartData = {
                    datasets: [{
                        label: '資格',
                        data: data.map(cert => ({ x: cert.difficulty, y: cert.necessity, r: cert.gai * 4, name: cert.name })),
                        backgroundColor: data.map(cert => `hsla(${180 + cert.gai * 20}, 80%, 60%, 0.7)`),
                        borderColor: data.map(cert => `hsla(${180 + cert.gai * 20}, 80%, 40%, 1)`),
                        borderWidth: 1,
                    }]
                };
                const options = {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1f2937', titleColor: '#e5e7eb', bodyColor: '#d1d5db',
                            callbacks: { label: (c) => `${c.raw.name} | 難易度: ${c.raw.x}, 必要性: ${c.raw.y}, やりがい: ${c.raw.r / 4}` }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: '難易度', color: '#9ca3af' }, grid: { color: '#374151' }, ticks: { color: '#9ca3af', stepSize: 1 }, min: 0, max: 6 },
                        y: { title: { display: true, text: '必要性', color: '#9ca3af' }, grid: { color: '#374151' }, ticks: { color: '#9ca3af', stepSize: 1 }, min: 0, max: 6 }
                    }
                };
                chartRef.current = new Chart(ctx, { type: 'bubble', data: chartData, options: options });
            }, [data]);
            return (
                <div className="relative w-full h-full">
                    <canvas ref={canvasRef}></canvas>
                    {(!data || data.length === 0) && <div className="absolute inset-0 flex items-center justify-center text-gray-500 bg-gray-800/50 rounded-lg p-4 text-center">表示するデータがありません。<br/>左のフォームから資格情報を追加またはアップロードしてください。</div>}
                </div>
            );
        };

        const ProgressDoughnutChart = ({ progressPercent }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            useEffect(() => {
                if (!canvasRef.current || typeof Chart === 'undefined') return;
                if (chartRef.current) chartRef.current.destroy();
                const ctx = currentCanvas.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [progressPercent, 100 - progressPercent],
                            backgroundColor: ['#22c55e', '#374151'],
                            borderColor: '#1f2937',
                            borderWidth: 4,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '70%',
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });
            }, [progressPercent]);
            return (
                <div className="relative w-full h-full flex items-center justify-center">
                    <canvas ref={canvasRef}></canvas>
                    <div className="absolute flex flex-col items-center justify-center">
                        <span className="text-2xl md:text-4xl font-bold text-white">{progressPercent.toFixed(1)}%</span>
                        <span className="text-xs md:text-sm text-gray-400">進捗率</span>
                    </div>
                </div>
            );
        };

        const AIReportModal = ({
            isOpen, onClose, reporter, setReporter, generateReport, generateComprehensiveReport,
            loadingReport, report, handlePdfExport, handleSaveReportToCalendar, selectedDate,
            currentCertId
        }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm md:max-w-3xl animate-fade-in-scale">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl md:text-2xl font-bold text-white">AIレポート</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                        </div>

                        <div className="flex flex-col md:flex-row gap-6">
                            {/* Left side: Settings and actions */}
                            <div className="w-full md:w-1/3 space-y-4 flex flex-col">
                                <div>
                                    <h4 className="text-lg font-bold mb-2">AIレポーター設定</h4>
                                    <input
                                        type="text"
                                        value={reporter}
                                        onChange={(e) => setReporter(e.target.value)}
                                        placeholder="例：熱血コーチ"
                                        className="w-full p-2 bg-gray-700 rounded-md"
                                    />
                                </div>
                                <div className="space-y-2 mt-auto">
                                    <button
                                        onClick={generateReport}
                                        className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed"
                                        disabled={loadingReport || !currentCertId}
                                    >
                                        {loadingReport ? '生成中...' : '個別レポートを生成'}
                                    </button>
                                    <button
                                        onClick={generateComprehensiveReport}
                                        className="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed"
                                        disabled={loadingReport}
                                    >
                                        {loadingReport ? '生成中...' : '総合レポートを生成'}
                                    </button>
                                    {!currentCertId && <p className="text-xs text-yellow-400 text-center pt-1">個別レポートには「進捗管理」タブでの資格選択が必要です。</p>}
                                </div>
                            </div>

                            {/* Right side: Report display */}
                            <div className="w-full md:w-2/3 bg-gray-900 p-4 rounded-lg h-80 md:h-96 overflow-y-auto">
                                {loadingReport ? (
                                    <div className="flex items-center justify-center h-full text-gray-400">レポートを生成中...</div>
                                ) : report ? (
                                    <div id="report-content" className="prose prose-invert max-w-none whitespace-pre-wrap leading-relaxed" dangerouslySetInnerHTML={{ __html: report.replace(/\n/g, '<br />') }}></div>
                                ) : (
                                    <div className="flex items-center justify-center h-full text-gray-500">ここにレポートが表示されます。</div>
                                )}
                            </div>
                        </div>

                        {report && !loadingReport && (
                            <div className="flex flex-col sm:flex-row justify-end gap-4 mt-6 border-t border-gray-700 pt-4">
                                <button onClick={handlePdfExport} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">PDF出力</button>
                                <button onClick={handleSaveReportToCalendar} disabled={!selectedDate} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50">選択中の日付に保存</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };


        const PrioritizationTab = ({ data, filters, handleFilterChange, certForm, handleFormChange, handleAddUpdateCert, editingCert, setEditingCert, handleCertFileUpload, handleDeleteCert }) => {
            const filteredCerts = useMemo(() => {
                return data.certifications.filter(cert => 
                    cert.difficulty >= filters.difficulty.min && cert.difficulty <= filters.difficulty.max &&
                    cert.necessity >= filters.necessity.min && cert.necessity <= filters.necessity.max &&
                    cert.gai >= filters.gai.min && cert.gai <= filters.gai.max
                );
            }, [data.certifications, filters]);

            return (
                <div className="flex flex-col lg:flex-row p-2 md:p-4 gap-4">
                    {/* Left Column */}
                    <div className="w-full lg:w-1/3 space-y-4">
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-2">1. 資格情報アップロード</h3>
                            <p className="text-sm text-gray-400 mb-2">Excel(.xlsx)またはJSON(.json)形式。<br/>Excel: A列=資格名, B=難易度, C=必要性, D=やりがい (2行目から)</p>
                            <input type="file" accept=".json,.xlsx,.xls" onChange={handleCertFileUpload} className="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer"/>
                        </div>
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-4">2. フィルター</h3>
                            {['difficulty', 'necessity', 'gai'].map(key => {
                                const labels = {difficulty: '難易度', necessity: '必要性', gai: 'やりがい'};
                                return (
                                <div key={key} className="mb-2">
                                    <label className="block text-sm font-medium mb-1">{labels[key]} ({filters[key].min} - {filters[key].max})</label>
                                    <div className="flex items-center space-x-2">
                                        <span>1</span>
                                        <input type="range" min="1" max="5" value={filters[key].min} onChange={e => handleFilterChange(key, 'min', e.target.value)} className="w-full" />
                                        <input type="range" min="1" max="5" value={filters[key].max} onChange={e => handleFilterChange(key, 'max', e.target.value)} className="w-full" />
                                        <span>5</span>
                                    </div>
                                </div>
                            )})}
                        </div>
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-4">{editingCert ? '資格情報の編集' : '3. 資格情報の手動追加'}</h3>
                            <div className="space-y-4">
                                <input type="text" name="name" value={certForm.name} onChange={handleFormChange} placeholder="資格名" className="w-full p-2 bg-gray-700 rounded-md"/>
                                {['difficulty', 'necessity', 'gai'].map(key => (
                                <div key={key}>
                                    <label className="block text-sm font-medium mb-1">{({difficulty: '難易度', necessity: '必要性', gai: 'やりがい'})[key]} (1-5)</label>
                                    <input type="number" name={key} value={certForm[key]} onChange={handleFormChange} min="1" max="5" className="w-full p-2 bg-gray-700 rounded-md"/>
                                </div>
                                ))}
                                <button onClick={handleAddUpdateCert} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">{editingCert ? '更新' : '追加'}</button>
                                {editingCert && <button onClick={() => setEditingCert(null)} className="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2">キャンセル</button>}
                            </div>
                        </div>
                    </div>
                    {/* Right Column */}
                    <div className="w-full lg:w-2/3 space-y-4">
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <div className="w-full h-[40vh] md:h-[50vh] lg:h-[60vh] min-h-[300px]">
                                <BubbleChart data={filteredCerts} />
                            </div>
                        </div>
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-4">資格一覧</h3>
                            <div className="overflow-auto max-h-[40vh]">
                                <table className="min-w-full divide-y divide-gray-700">
                                    <thead className="bg-gray-700 sticky top-0"><tr>{['資格名', '難易度', '必要性', 'やりがい', 'アクション'].map(h => <th key={h} className="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase">{h}</th>)}</tr></thead>
                                    <tbody className="bg-gray-800 divide-y divide-gray-700">
                                        {filteredCerts.length > 0 ? filteredCerts.map(cert => (
                                            <tr key={cert.id} className="hover:bg-gray-700/50">
                                                <td className="px-2 md:px-4 py-2 text-sm font-medium text-white">{cert.name}</td>
                                                <td className="px-2 md:px-4 py-2 text-sm text-gray-300">{cert.difficulty}</td>
                                                <td className="px-2 md:px-4 py-2 text-sm text-gray-300">{cert.necessity}</td>
                                                <td className="px-2 md:px-4 py-2 text-sm text-gray-300">{cert.gai}</td>
                                                <td className="px-2 md:px-4 py-2 text-sm font-medium space-x-2">
                                                    <button onClick={() => setEditingCert(cert)} className="text-indigo-400 hover:text-indigo-600">編集</button>
                                                    <button onClick={() => handleDeleteCert(cert.id)} className="text-red-400 hover:text-red-600">削除</button>
                                                </td>
                                            </tr>
                                        )) : (<tr><td colSpan="5" className="text-center py-4 text-gray-500">該当する資格がありません。</td></tr>)}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ProgressTab = ({ data, currentCertId, setCurrentCertId, saveDataToFirestore, handleProgressFileUpload, newMajorItemName, setNewMajorItemName, handleAddMajorItem, parentMajorItemId, setParentMajorItemId, newMinorItemName, setNewMinorItemName, handleAddMinorItem, handleProgressCheckbox, progressPercent, openModal }) => {
            return (
                <div className="flex flex-col lg:flex-row p-2 md:p-4 gap-4">
                    {/* Left Column */}
                    <div className="w-full lg:w-1/3 space-y-4">
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-4">学習中の資格設定</h3>
                            <select value={currentCertId || ''} onChange={(e) => setCurrentCertId(e.target.value)} className="w-full p-2 bg-gray-700 rounded-md mb-4">
                                <option value="">資格を選択...</option>
                                {data.certifications.map((cert) => <option key={cert.id} value={cert.id}>{cert.name}</option>)}
                            </select>
                            <label className="block text-sm font-medium mb-1">目標取得日</label>
                            <input type="date" value={data.progress[currentCertId]?.targetDate || ''} onChange={async (e) => {
                                if (!currentCertId) return;
                                const updatedProgress = { ...data.progress, [currentCertId]: { ...(data.progress[currentCertId] || {}), targetDate: e.target.value } };
                                await saveDataToFirestore({ ...data, progress: updatedProgress });
                            }} className="w-full p-2 bg-gray-700 rounded-md"/>
                        </div>
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-4">学習項目アップロード/追加</h3>
                            <p className="text-sm text-gray-400 mb-2">Excelファイルをアップロード (●:大項目, ・:小項目)</p>
                            <input type="file" accept=".xlsx" onChange={handleProgressFileUpload} className="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer"/>
                            <div className="mt-4 border-t border-gray-700 pt-4 space-y-2">
                                <h4 className="text-lg font-bold mb-2">手動で追加</h4>
                                <input type="text" value={newMajorItemName} onChange={(e) => setNewMajorItemName(e.target.value)} placeholder="大項目名" className="w-full p-2 bg-gray-700 rounded-md"/>
                                <button onClick={handleAddMajorItem} disabled={!currentCertId} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50">大項目を追加</button>
                                <select value={parentMajorItemId} onChange={(e) => setParentMajorItemId(e.target.value)} className="w-full p-2 bg-gray-700 rounded-md mt-4">
                                    <option value="">親となる大項目を選択...</option>
                                    {Object.entries(data.progress[currentCertId]?.items || {}).map(([key, item]) => <option key={key} value={key}>{item.name}</option>)}
                                </select>
                                <input type="text" value={newMinorItemName} onChange={(e) => setNewMinorItemName(e.target.value)} placeholder="小項目名" className="w-full p-2 bg-gray-700 rounded-md"/>
                                <button onClick={handleAddMinorItem} disabled={!parentMajorItemId} className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50">小項目を追加</button>
                            </div>
                        </div>
                    </div>
                    {/* Right Column */}
                    <div className="w-full lg:w-2/3 space-y-4">
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 className="text-xl font-bold mb-4">{data.certifications.find(c => c.id === currentCertId)?.name || '資格を選択してください'}</h3>
                            <div className="w-full bg-gray-700 rounded-full h-4 mb-4">
                                <div className="bg-green-500 h-4 rounded-full text-xs flex items-center justify-center text-white font-bold" style={{ width: `${progressPercent}%` }}>
                                    {progressPercent > 10 && `${progressPercent.toFixed(1)}%`}
                                </div>
                            </div>
                            <div className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                                {Object.entries(data.progress[currentCertId]?.items || {}).map(([majorKey, majorItem]) => (
                                    <div key={majorKey} className="p-2 rounded bg-gray-700/50">
                                        <h5 className="font-bold mb-1">{majorItem.name}</h5>
                                        <div className="pl-4 space-y-1">
                                            {Object.entries(majorItem.subItems || {}).map(([minorKey, minorItem]) => (
                                                <label key={minorKey} className="flex items-center space-x-2 cursor-pointer">
                                                    <input type="checkbox" checked={minorItem.checked} onChange={() => handleProgressCheckbox(minorKey, majorKey)} className="form-checkbox h-4 w-4 text-blue-600 bg-gray-900 border-gray-700 rounded focus:ring-blue-500" />
                                                    <span className={`text-gray-300 ${minorItem.checked ? 'line-through text-gray-500' : ''}`}>{minorItem.name}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportTab = ({ data, currentCertId, progressPercent, daysRemaining, certName, totalStudyTime, viewDate, setViewDate, selectedDate, setSelectedDate, note, setNote, studyTime, setStudyTime, saveDataToFirestore, openModal, setIsAiReportModalOpen }) => {
            
            const handleSaveCalendarEntry = async () => {
                if (!selectedDate) return;
                if (!currentCertId) {
                    openModal('エラー', '記録を保存するには、「進捗管理」タブで学習中の資格を選択してください。');
                    return;
                }
                const dateKey = selectedDate.toISOString().split('T')[0];
                const updatedCalendar = JSON.parse(JSON.stringify(data.calendar || {}));
                if (!updatedCalendar[dateKey]) updatedCalendar[dateKey] = {};
                if (!updatedCalendar[dateKey].studyLog) updatedCalendar[dateKey].studyLog = {};
                updatedCalendar[dateKey].note = note;
                updatedCalendar[dateKey].studyLog[currentCertId] = Number(studyTime) || 0;
                await saveDataToFirestore({ ...data, calendar: updatedCalendar });
                openModal('保存完了', `${dateKey} の記録を保存しました。`);
            };
            
            const calendarDays = useMemo(() => {
                const year = viewDate.getFullYear();
                const month = viewDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < firstDayOfMonth; i++) days.push(null);
                for (let i = 1; i <= daysInMonth; i++) days.push(new Date(year, month, i));
                return days;
            }, [viewDate]);
            
            return (
                <div className="p-2 md:p-4 space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        <div className="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg flex flex-col items-center justify-center">
                            <div className="text-4xl md:text-5xl font-bold text-indigo-400">
                                {daysRemaining !== null ? (daysRemaining >= 0 ? daysRemaining : '期限切れ') : '-'}
                            </div>
                            <div className="text-sm md:text-lg text-gray-400 mt-2">目標日までの日数</div>
                        </div>
                        <div className="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg flex flex-col items-center justify-center">
                            <div className="text-4xl md:text-5xl font-bold text-green-400">
                                {totalStudyTime > 0 ? `${Math.floor(totalStudyTime / 60)}h ${totalStudyTime % 60}m` : '-'}
                            </div>
                            <div className="text-sm md:text-lg text-gray-400 mt-2">累計学習時間</div>
                        </div>
                        <div className="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg flex flex-col items-center justify-center">
                             <div className="w-24 h-24 md:w-32 md:h-32">
                                 <ProgressDoughnutChart progressPercent={currentCertId ? progressPercent : 0} />
                             </div>
                             <div className="text-sm md:text-lg text-gray-400 mt-2 md:mt-4 text-center">{certName || '資格未選択'}</div>
                        </div>
                        <div className="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg flex flex-col justify-center text-center">
                            <h3 className="text-xl font-bold mb-2">AIレポート</h3>
                            <p className="text-xs md:text-sm text-gray-400 mb-4">学習状況を分析し、パーソナライズされたレポートとアドバイスを生成します。</p>
                            <button
                                onClick={() => setIsAiReportModalOpen(true)}
                                className="w-full mt-auto bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105"
                            >
                                AIレポートを開く
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg">
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => setViewDate(new Date(viewDate.setMonth(viewDate.getMonth() - 1)))} className="p-2 rounded-full hover:bg-gray-700">&lt;</button>
                                <h3 className="text-lg md:text-xl font-bold">{viewDate.getFullYear()}年 {viewDate.getMonth() + 1}月</h3>
                                <button onClick={() => setViewDate(new Date(viewDate.setMonth(viewDate.getMonth() + 1)))} className="p-2 rounded-full hover:bg-gray-700">&gt;</button>
                            </div>
                            <div className="grid grid-cols-7 gap-1 text-center text-xs text-gray-400 mb-2">
                                {['日', '月', '火', '水', '木', '金', '土'].map(d => <div key={d}>{d}</div>)}
                            </div>
                            <div className="grid grid-cols-7 gap-1">
                                {calendarDays.map((day, i) => (
                                    <button
                                        key={i}
                                        onClick={() => day && setSelectedDate(day)}
                                        className={`w-full aspect-square rounded-lg flex items-center justify-center text-sm transition-colors
                                            ${day ? 'hover:bg-gray-700' : 'cursor-default'}
                                            ${day && selectedDate && day.toDateString() === selectedDate.toDateString() ? 'day-selected' : ''}
                                            ${day && data.calendar?.[day.toISOString().split('T')[0]] ? 'bg-indigo-900/50' : 'bg-gray-700/30'}
                                        `}
                                    >
                                        {day?.getDate()}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg">
                             <h3 className="text-lg md:text-xl font-bold mb-4">
                                 {selectedDate ? `${selectedDate.toLocaleDateString('ja-JP')} の記録` : '日付を選択してください'}
                             </h3>
                             <div className="space-y-4">
                                 <div>
                                     <label className="text-sm text-gray-400 mb-1 block">学習時間（分）</label>
                                     <input
                                         type="number"
                                         value={studyTime}
                                         onChange={(e) => setStudyTime(e.target.value)}
                                         placeholder="例: 60"
                                         disabled={!selectedDate || !currentCertId}
                                         className="w-full p-2 bg-gray-700 rounded-md disabled:opacity-50"
                                     />
                                 </div>
                                 <div>
                                     <label className="text-sm text-gray-400 mb-1 block">メモ</label>
                                     <textarea
                                         value={note}
                                         onChange={(e) => setNote(e.target.value)}
                                         placeholder="その日の学習内容や気づきを記録..."
                                         disabled={!selectedDate}
                                         className="w-full h-28 p-2 bg-gray-700 rounded-md disabled:opacity-50"
                                     ></textarea>
                                 </div>
                             </div>
                             <button onClick={handleSaveCalendarEntry} disabled={!selectedDate || !currentCertId} className="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50">
                                 {currentCertId ? 'この日の記録を保存' : '先に資格を選択'}
                             </button>
                             {selectedDate && data.calendar?.[selectedDate.toISOString().split('T')[0]]?.report && (
                                 <div className="mt-4">
                                     <h4 className="font-bold text-lg mb-2">保存されたレポート</h4>
                                     <div className="p-3 bg-gray-700/50 rounded-lg text-sm whitespace-pre-wrap max-h-32 overflow-y-auto">{data.calendar[selectedDate.toISOString().split('T')[0]].report}</div>
                                 </div>
                             )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- メインアプリケーションコンポーネント ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            const [data, setData] = useState({ certifications: [], progress: {}, calendar: {} });
            const [currentTab, setCurrentTab] = useState('tab-1');
            const [editingCert, setEditingCert] = useState(null);
            const [currentCertId, setCurrentCertId] = useState(null);
            const [certForm, setCertForm] = useState({ name: '', difficulty: 3, necessity: 3, gai: 3 });
            const [filters, setFilters] = useState({ difficulty: { min: 1, max: 5 }, necessity: { min: 1, max: 5 }, gai: { min: 1, max: 5 } });
            const [newMajorItemName, setNewMajorItemName] = useState('');
            const [newMinorItemName, setNewMinorItemName] = useState('');
            const [parentMajorItemId, setParentMajorItemId] = useState('');
            const [loadingReport, setLoadingReport] = useState(false);
            const [report, setReport] = useState('');
            const [reporter, setReporter] = useState('熱血コーチ');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState({ title: '', body: '', onConfirm: null });
            const [isAiReportModalOpen, setIsAiReportModalOpen] = useState(false);
            
            const [viewDate, setViewDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [note, setNote] = useState('');
            const [studyTime, setStudyTime] = useState('');

            const firebaseServices = useRef(null);

            // --- Firebase初期化 & 認証監視 ---
            useEffect(() => {
                if (firebaseServices.current) return;
                try {
                    if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIzaSy...")) {
                        throw new Error("Firebaseの設定が不完全です。コード内の`firebaseConfig`オブジェクトにご自身のプロジェクト情報を設定してください。");
                    }
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    firebaseServices.current = { app, auth, db };

                    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                        setUser(currentUser);
                        setLoading(false);
                    });
                    return () => unsubscribe();
                } catch (err) {
                    console.error("Firebase Init Error:", err);
                    setError(err.message);
                    setLoading(false);
                }
            }, []);

            // --- データ購読 ---
            useEffect(() => {
                if (!user) {
                    setData({ certifications: [], progress: {}, calendar: {} });
                    return;
                }
                const { db } = firebaseServices.current;
                const userDocRef = doc(db, "users", user.uid);
                
                const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        setData({
                            certifications: d.certifications ? JSON.parse(d.certifications) : [],
                            progress: d.progress ? JSON.parse(d.progress) : {},
                            calendar: d.calendar ? JSON.parse(d.calendar) : {}
                        });
                    } else {
                        saveDataToFirestore({ certifications: [], progress: {}, calendar: {} });
                    }
                }, (err) => {
                    console.error("Data subscription error:", err);
                    openModal('データ読み込みエラー', `データの読み込みに失敗しました。エラー: ${err.code}`);
                });
                return () => unsubscribe();
            }, [user]);
            
            // --- データ保存 ---
            const saveDataToFirestore = useCallback(async (fullDataToSave) => {
                if (!user) return;
                const { db } = firebaseServices.current;
                const userDocRef = doc(db, "users", user.uid);
                try {
                    await setDoc(userDocRef, {
                        certifications: JSON.stringify(fullDataToSave.certifications || []),
                        progress: JSON.stringify(fullDataToSave.progress || {}),
                        calendar: JSON.stringify(fullDataToSave.calendar || {})
                    });
                } catch (err) {
                    console.error("Save data error:", err);
                    openModal('データ保存エラー', `データの保存に失敗しました。エラー: ${err.message}`);
                }
            }, [user]);

            // --- 認証ハンドラ ---
            const handleGoogleLogin = () => {
                const { auth } = firebaseServices.current;
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider)
                    .catch((error) => {
                        console.error("Google Popup Signin Error", error);
                        setError(`Googleログインに失敗しました: ${error.code}`);
                    });
            };

            const handleAnonymousLogin = () => {
                const { auth } = firebaseServices.current;
                signInAnonymously(auth).catch(err => {
                    console.error("Anonymous Login Error:", err);
                    setError(`匿名ログインに失敗しました: ${err.code}`);
                });
            };

            const handleLogout = async () => {
                const { auth } = firebaseServices.current;
                await signOut(auth);
            };

            // --- モーダル制御 ---
            const openModal = (title, body, onConfirm = null) => {
                setModalContent({ title, body, onConfirm });
                setIsModalOpen(true);
            };
            const closeModal = () => setIsModalOpen(false);

            // --- フォームハンドラ ---
            const handleFormChange = (e) => {
                const { name, value } = e.target;
                setCertForm(prev => ({ ...prev, [name]: value }));
            };
            const handleAddUpdateCert = async () => {
                if (!certForm.name.trim()) { openModal('入力エラー', '資格名を入力してください。'); return; }
                const newCert = { ...certForm, id: editingCert ? editingCert.id : uuidv4(), difficulty: Number(certForm.difficulty), necessity: Number(certForm.necessity), gai: Number(certForm.gai) };
                const updatedCerts = editingCert ? data.certifications.map(c => c.id === newCert.id ? newCert : c) : [...data.certifications, newCert];
                await saveDataToFirestore({ ...data, certifications: updatedCerts });
                setEditingCert(null);
                setCertForm({ name: '', difficulty: 3, necessity: 3, gai: 3 });
            };
            useEffect(() => {
                if (editingCert) {
                    setCertForm(editingCert);
                } else {
                    setCertForm({ name: '', difficulty: 3, necessity: 3, gai: 3 });
                }
            }, [editingCert]);

            const handleDeleteCert = (id) => {
                openModal('確認', 'この資格情報を削除しますか？\n関連する進捗データもすべて削除されます。', async () => {
                    const updatedCerts = data.certifications.filter(c => c.id !== id);
                    const updatedProgress = { ...data.progress };
                    delete updatedProgress[id];
                    await saveDataToFirestore({ ...data, certifications: updatedCerts, progress: updatedProgress });
                    if (currentCertId === id) setCurrentCertId(null);
                    closeModal();
                });
            };
            const handleFilterChange = (filterName, type, value) => {
                setFilters(prev => {
                    const newFilter = { ...prev[filterName], [type]: Number(value) };
                    if (type === 'min' && newFilter.min > newFilter.max) newFilter.max = newFilter.min;
                    if (type === 'max' && newFilter.max < newFilter.min) newFilter.min = newFilter.max;
                    return { ...prev, [filterName]: newFilter };
                });
            };
            const handleCertFileUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        let newCerts = [];
                        if (file.name.endsWith('.json')) { newCerts = JSON.parse(event.target.result).map(c => ({...c, id: c.id || uuidv4()})); } 
                        else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                            const wb = XLSX.read(event.target.result, { type: 'binary' });
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(ws, { header: ['name', 'difficulty', 'necessity', 'gai'], range: 1 });
                            newCerts = jsonData.filter(c => c.name && !isNaN(c.difficulty) && !isNaN(c.necessity) && !isNaN(c.gai)).map(c => ({...c, id: uuidv4()}));
                        }
                        if (newCerts.length > 0) {
                            await saveDataToFirestore({ ...data, certifications: newCerts });
                            openModal('成功', `${newCerts.length}件の資格情報をアップロードしました。`);
                        } else { openModal('エラー', '有効なデータが見つかりませんでした。'); }
                    } catch (error) { openModal('ファイル読み込みエラー', `エラー: ${error.message}`); }
                };
                reader.readAsBinaryString(file); e.target.value = null;
            };
            const handleProgressFileUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                if (!currentCertId) { openModal("エラー", "先に学習中の資格を選択してください。"); e.target.value = null; return; }
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const workbook = XLSX.read(event.target.result, { type: 'binary' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        const items = {}; let currentMajorItemKey = null;
                        jsonData.forEach(row => {
                            const cellValue = row[0];
                            if (typeof cellValue === 'string' && cellValue.trim() !== '') {
                                const trimmedValue = cellValue.trim();
                                if (trimmedValue.startsWith('●')) {
                                    currentMajorItemKey = uuidv4();
                                    items[currentMajorItemKey] = { name: trimmedValue.substring(1).trim(), checked: false, type: 'major', subItems: {} };
                                } else if ((trimmedValue.startsWith('・') || trimmedValue.startsWith('-')) && currentMajorItemKey) {
                                    const subItemKey = uuidv4();
                                    items[currentMajorItemKey].subItems[subItemKey] = { name: trimmedValue.substring(1).trim(), checked: false, type: 'minor' };
                                }
                            }
                        });
                        const updatedProgress = JSON.parse(JSON.stringify(data.progress));
                        updatedProgress[currentCertId] = { ...(updatedProgress[currentCertId] || {}), items: items };
                        await saveDataToFirestore({ ...data, progress: updatedProgress });
                        openModal('成功', '学習項目のアップロードが完了しました！');
                    } catch (error) { openModal('ファイル読み込みエラー', `エラー: ${error.message}`); }
                };
                reader.readAsBinaryString(file); e.target.value = null;
            };
            const handleProgressCheckbox = async (minorId, majorId) => {
                const updatedProgress = JSON.parse(JSON.stringify(data.progress));
                const certProgress = updatedProgress[currentCertId];
                if (certProgress?.items?.[majorId]?.subItems?.[minorId]) {
                    certProgress.items[majorId].subItems[minorId].checked = !certProgress.items[majorId].subItems[minorId].checked;
                    certProgress.items[majorId].checked = Object.values(certProgress.items[majorId].subItems).every(item => item.checked);
                    await saveDataToFirestore({ ...data, progress: updatedProgress });
                }
            };
            const handleAddMajorItem = async () => {
                if (!currentCertId || !newMajorItemName.trim()) return;
                const updatedProgress = JSON.parse(JSON.stringify(data.progress));
                const currentCertProgress = updatedProgress[currentCertId] || { items: {} };
                currentCertProgress.items = currentCertProgress.items || {};
                const newMajorKey = uuidv4();
                currentCertProgress.items[newMajorKey] = { name: newMajorItemName.trim(), checked: false, type: 'major', subItems: {} };
                updatedProgress[currentCertId] = currentCertProgress;
                await saveDataToFirestore({ ...data, progress: updatedProgress });
                setNewMajorItemName('');
            };
            const handleAddMinorItem = async () => {
                if (!currentCertId || !newMinorItemName.trim() || !parentMajorItemId) return;
                const updatedProgress = JSON.parse(JSON.stringify(data.progress));
                const currentCertProgress = updatedProgress[currentCertId];
                if (currentCertProgress?.items?.[parentMajorItemId]) {
                    const newMinorKey = uuidv4();
                    currentCertProgress.items[parentMajorItemId].subItems[newMinorKey] = { name: newMinorItemName.trim(), checked: false, type: 'minor' };
                    await saveDataToFirestore({ ...data, progress: updatedProgress });
                    setNewMinorItemName('');
                }
            };

            const { progressPercent, daysRemaining, certName, totalTasks, completedTasks, totalStudyTime } = useMemo(() => {
                if (!currentCertId) return { progressPercent: 0, daysRemaining: null, certName: '', totalTasks: 0, completedTasks: 0, totalStudyTime: 0 };
                const progressData = data.progress[currentCertId];
                const certName = data.certifications.find(c => c.id === currentCertId)?.name || '';
                let total = 0, completed = 0;
                if (progressData && progressData.items) {
                    Object.values(progressData.items).forEach(major => {
                        const subItems = major.subItems || {};
                        total += Object.keys(subItems).length;
                        completed += Object.values(subItems).filter(s => s.checked).length;
                    });
                }
                const percent = total > 0 ? (completed / total) * 100 : 0;
                let remaining = null;
                if (progressData && progressData.targetDate) {
                    const target = new Date(progressData.targetDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    remaining = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                }
                let cumulativeTime = 0;
                if (data.calendar) {
                    Object.values(data.calendar).forEach(dayData => {
                        if (dayData.studyLog && dayData.studyLog[currentCertId]) {
                            cumulativeTime += Number(dayData.studyLog[currentCertId]);
                        }
                    });
                }
                return { progressPercent: percent, daysRemaining: remaining, certName, totalTasks: total, completedTasks: completed, totalStudyTime: cumulativeTime };
            }, [currentCertId, data]);
            
            const comprehensiveData = useMemo(() => {
                const totalCerts = data.certifications.length;
                const inProgressCerts = Object.keys(data.progress);
                const inProgressCertsCount = inProgressCerts.length;
                
                const details = inProgressCerts.map(certId => {
                    const cert = data.certifications.find(c => c.id === certId);
                    if (!cert) return null;

                    const progressData = data.progress[certId];
                    let total = 0, completed = 0;
                    if (progressData && progressData.items) {
                        Object.values(progressData.items).forEach(major => {
                            const subItems = major.subItems || {};
                            total += Object.keys(subItems).length;
                            completed += Object.values(subItems).filter(s => s.checked).length;
                        });
                    }
                    const percent = total > 0 ? (completed / total) * 100 : 0;

                    let remaining = null;
                    if (progressData && progressData.targetDate) {
                        const target = new Date(progressData.targetDate);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        remaining = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                    }

                    let cumulativeTime = 0;
                    if (data.calendar) {
                        Object.values(data.calendar).forEach(dayData => {
                            if (dayData.studyLog && dayData.studyLog[certId]) {
                                cumulativeTime += Number(dayData.studyLog[certId]);
                            }
                        });
                    }
                    
                    return {
                        name: cert.name,
                        progressPercent: percent,
                        daysRemaining: remaining,
                        totalStudyTime: cumulativeTime
                    };
                }).filter(Boolean);

                return { totalCerts, inProgressCertsCount, details };
            }, [data]);

            const generateReportWithExponentialBackoff = async (payload, retries = 5, delay = 1000) => {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`API Error ${response.status}`);
                        }
                        if (!response.ok) {
                           const errorBody = await response.json();
                           console.error("API Error Body:", errorBody);
                           throw new Error(`APIエラー: ${response.status} ${response.statusText}`);
                        }
                        const result = await response.json();
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) return text;
                        else throw new Error('レポートのテキストが取得できませんでした。');
                    } catch (err) {
                        if (i === retries - 1) throw err;
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    }
                }
            };

            const generateReport = async () => {
                setLoadingReport(true); setReport('');
                try {
                    if (!currentCertId) throw new Error('レポートを生成する資格を選択してください。');
                    const prompt = `あなたは「${reporter}」です。以下の学習状況を分析し、そのキャラクターになりきって学習者を力強く励ます評価と、具体的で実行可能な次のアクションを提案してください。レポートは情熱的かつ分かりやすく、markdown形式で記述してください。\n\n### 学習状況\n- **資格名**: ${certName}\n- **目標取得日までの残り日数**: ${daysRemaining !== null ? `${daysRemaining}日` : '未設定'}\n- **累計学習時間**: ${Math.floor(totalStudyTime / 60)}時間 ${totalStudyTime % 60}分\n- **総学習項目数**: ${totalTasks}\n- **完了項目数**: ${completedTasks}\n- **進捗率**: ${progressPercent.toFixed(1)}%`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const text = await generateReportWithExponentialBackoff(payload);
                    setReport(text);
                } catch (err) {
                    console.error("Report generation failed:", err);
                    openModal('レポート生成エラー', `エラーが発生しました: ${err.message}`);
                }
                setLoadingReport(false);
            };

            const generateComprehensiveReport = async () => {
                setLoadingReport(true); setReport('');
                try {
                    let detailsText = comprehensiveData.details.map(d => 
                        `- **資格名**: ${d.name}\n  - **進捗率**: ${d.progressPercent.toFixed(1)}%\n  - **累計学習時間**: ${Math.floor(d.totalStudyTime / 60)}時間 ${d.totalStudyTime % 60}分\n  - **目標日までの残り日数**: ${d.daysRemaining !== null ? `${d.daysRemaining}日` : '未設定'}`
                    ).join('\n');
                    if (!detailsText) detailsText = "学習中の資格はありません。";

                    const prompt = `あなたは「${reporter}」です。以下の学習状況全体を分析し、学習者を力強く励ます総合的な評価と、今後の学習戦略について具体的なアドバイスを提案してください。レポートは情熱的かつ分かりやすく、markdown形式で記述してください。\n\n### 全体状況\n- **総登録資格数**: ${comprehensiveData.totalCerts}\n- **学習中の資格数**: ${comprehensiveData.inProgressCertsCount}\n\n### 学習中資格の詳細\n${detailsText}`;
                    
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const text = await generateReportWithExponentialBackoff(payload);
                    setReport(text);
                } catch (err) {
                    console.error("Comprehensive report generation failed:", err);
                    openModal('レポート生成エラー', `エラーが発生しました: ${err.message}`);
                }
                setLoadingReport(false);
            };

            const handlePdfExport = async () => {
                const reportElement = document.getElementById('report-content');
                if (!reportElement) return;
                openModal("PDF生成中", "レポートのPDFを生成しています...");
                try {
                    const canvas = await html2canvas(reportElement, { backgroundColor: '#111827' });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min((pdfWidth - 20) / imgWidth, (pdfHeight - 20) / imgHeight);
                    const imgX = (pdfWidth - imgWidth * ratio) / 2;
                    const imgY = 10;
                    pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                    pdf.save(`${certName || 'comprehensive'}_report_${new Date().toISOString().split('T')[0]}.pdf`);
                } catch (err) {
                    console.error("PDF Export Error: ", err);
                    openModal("PDF生成エラー", `PDFの生成に失敗しました: ${err.message}`);
                } finally {
                    closeModal();
                }
            };
            const handleSaveReportToCalendar = async () => {
                if (!selectedDate || !report) return;
                const dateKey = selectedDate.toISOString().split('T')[0];
                const updatedCalendar = JSON.parse(JSON.stringify(data.calendar || {}));
                if (!updatedCalendar[dateKey]) updatedCalendar[dateKey] = {};
                updatedCalendar[dateKey].report = report;
                await saveDataToFirestore({ ...data, calendar: updatedCalendar });
                openModal('保存完了', `${dateKey} にレポートを保存しました。`);
            };
            
            useEffect(() => {
                if (selectedDate && data.calendar) {
                    const dateKey = selectedDate.toISOString().split('T')[0];
                    const dayData = data.calendar[dateKey];
                    setNote(dayData?.note || '');
                    setStudyTime(dayData?.studyLog?.[currentCertId] || '');
                } else {
                    setNote('');
                    setStudyTime('');
                }
            }, [selectedDate, currentCertId, data.calendar]);


            if (loading) { return <div className="flex items-center justify-center h-full"><h2 className="text-2xl font-bold">接続中...</h2></div>; }
            
            if (!user) {
                return (
                    <div className="flex flex-col items-center justify-center h-full bg-gray-900 p-4">
                        <div className="text-center p-8 bg-gray-800 rounded-lg shadow-2xl max-w-md w-full">
                            <h1 className="text-3xl md:text-4xl font-extrabold text-white mb-4" style={{fontFamily: "'Inter', sans-serif"}}>資格取得管理ダッシュボード</h1>
                            <p className="text-gray-400 mb-8">ログイン方法を選択してください</p>
                            {error && (
                                <div className="text-red-400 mb-4 bg-red-900/50 p-3 rounded-md text-left">
                                    <p className="font-bold">エラーが発生しました</p>
                                    <p className="text-sm mt-1">{error}</p>
                                </div>
                            )}
                            <div className="space-y-4">
                                <button onClick={handleGoogleLogin} className="w-full flex items-center justify-center gap-3 bg-white hover:bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors">
                                    <svg className="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                                    Googleでログイン
                                </button>
                                <button onClick={handleAnonymousLogin} className="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                                    匿名で続ける
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-2 md:p-4 relative">
                    {isModalOpen && <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div className="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
                            <h3 className="text-lg font-bold text-white mb-4">{modalContent.title}</h3>
                            <div className="text-gray-300 mb-6" style={{whiteSpace: 'pre-wrap'}}>{modalContent.body}</div>
                            <div className="flex justify-end space-x-4">
                                {modalContent.onConfirm && <button onClick={() => { modalContent.onConfirm(); closeModal(); }} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">はい</button>}
                                <button onClick={closeModal} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">{modalContent.onConfirm ? 'キャンセル' : '閉じる'}</button>
                            </div>
                        </div>
                    </div>}

                    <AIReportModal
                        isOpen={isAiReportModalOpen}
                        onClose={() => setIsAiReportModalOpen(false)}
                        reporter={reporter}
                        setReporter={setReporter}
                        generateReport={generateReport}
                        generateComprehensiveReport={generateComprehensiveReport}
                        loadingReport={loadingReport}
                        report={report}
                        handlePdfExport={handlePdfExport}
                        handleSaveReportToCalendar={handleSaveReportToCalendar}
                        selectedDate={selectedDate}
                        certName={certName}
                        currentCertId={currentCertId}
                    />

                    <header className="text-center mb-8 px-2">
                        <div className="flex flex-col sm:flex-row justify-center items-center relative gap-4">
                            <h1 className="text-2xl sm:text-3xl md:text-4xl font-extrabold text-white" style={{fontFamily: "'Inter', sans-serif"}}>資格取得管理ダッシュボード</h1>
                            <button onClick={handleLogout} className="w-full sm:w-auto sm:absolute sm:right-0 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ログアウト</button>
                        </div>
                         <div className="mt-2 text-xs text-gray-500 font-mono break-all">ユーザー: {user.isAnonymous ? `ゲスト (${user.uid.substring(0,8)}...)` : user.displayName || user.email}</div>
                    </header>
                    <nav className="mb-8 border-b border-gray-700">
                        <div className="flex justify-center space-x-1 md:space-x-4">
                            {[{id: 'tab-1', label: '優先順位'}, {id: 'tab-2', label: '進捗管理'}, {id: 'tab-3', label: 'レポート'}].map(tab => (
                                <button key={tab.id} onClick={() => setCurrentTab(tab.id)} className={`py-2 px-3 md:px-4 font-bold rounded-t-lg text-sm md:text-base ${currentTab === tab.id ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-700/50'}`}>
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                    </nav>
                    <main>
                        {currentTab === 'tab-1' && <PrioritizationTab
                            data={data}
                            filters={filters}
                            handleFilterChange={handleFilterChange}
                            certForm={certForm}
                            handleFormChange={handleFormChange}
                            handleAddUpdateCert={handleAddUpdateCert}
                            editingCert={editingCert}
                            setEditingCert={setEditingCert}
                            handleCertFileUpload={handleCertFileUpload}
                            handleDeleteCert={handleDeleteCert}
                        />}
                        {currentTab === 'tab-2' && <ProgressTab
                            data={data}
                            currentCertId={currentCertId}
                            setCurrentCertId={setCurrentCertId}
                            saveDataToFirestore={saveDataToFirestore}
                            handleProgressFileUpload={handleProgressFileUpload}
                            newMajorItemName={newMajorItemName}
                            setNewMajorItemName={setNewMajorItemName}
                            handleAddMajorItem={handleAddMajorItem}
                            parentMajorItemId={parentMajorItemId}
                            setParentMajorItemId={setParentMajorItemId}
                            newMinorItemName={newMinorItemName}
                            setNewMinorItemName={setNewMinorItemName}
                            handleAddMinorItem={handleAddMinorItem}
                            handleProgressCheckbox={handleProgressCheckbox}
                            progressPercent={progressPercent}
                            openModal={openModal}
                        />}
                        {currentTab === 'tab-3' && <ReportTab
                            data={data}
                            currentCertId={currentCertId}
                            progressPercent={progressPercent}
                            daysRemaining={daysRemaining}
                            certName={certName}
                            totalStudyTime={totalStudyTime}
                            viewDate={viewDate}
                            setViewDate={setViewDate}
                            selectedDate={selectedDate}
                            setSelectedDate={setSelectedDate}
                            note={note}
                            setNote={setNote}
                            studyTime={studyTime}
                            setStudyTime={setStudyTime}
                            saveDataToFirestore={saveDataToFirestore}
                            openModal={openModal}
                            setIsAiReportModalOpen={setIsAiReportModalOpen}
                        />}
                    </main>
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>







































